<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Dnsmasq安装及配置</title>
      <link href="/2019/10/07/dnsmasq-install/"/>
      <url>/2019/10/07/dnsmasq-install/</url>
      
        <content type="html"><![CDATA[<h3 id="一、Dnsmasq介绍"><a href="#一、Dnsmasq介绍" class="headerlink" title="一、Dnsmasq介绍"></a>一、Dnsmasq介绍</h3><h4 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h4><blockquote><p>Dnsmasq是一个小巧且方便地用于配置DNS和DHCP的工具，作为域名解析服务器(DNS)，dnsmasq可以通过缓存 DNS 请求来提高对访问过的网址的连接速度。</p></blockquote><a id="more"></a><br><h4 id="1-2-原理"><a href="#1-2-原理" class="headerlink" title="1.2 原理"></a>1.2 原理</h4><ul><li>本机APP访问主机的/etc/resolv.conf获取DNSServer，该文件指向的DNSServer为Dnsmasq。</li><li>本地局域网中的主机可以直接访问Dnsmasq，即在这些主机中/etc/resolv.conf指向了Dnsmasq。</li><li>Dnsmasq需要通过上游DNS来进行域名解析，上游DNS可以配置在/etc/resolv.dnsmasq.conf中，该文件需要在Dnsmasq的配置文件/etc/dnsmasq.conf中指定。</li></ul><br><h4 id="1-3-主要功能"><a href="#1-3-主要功能" class="headerlink" title="1.3 主要功能"></a>1.3 主要功能</h4><ul><li><p>将Dnsmasq作为本地DNS服务器使用，直接修改电脑的本地DNS的IP地址即可。</p></li><li><p>应对ISP的DNS劫持（反DNS劫持），输入一个不存在的域名，正常的情况下浏览器是显示无法连接，DNS劫持会跳转到一个广告页面。先随便nslookup 一个不存在的域名，看看ISP商劫持的IP地址。</p></li><li><p>智能DNS加快解析速度，打开/etc/dnsmasq.conf文件，server=后面可以添加指定的DNS，例如国内外不同的网站使用不同的DNS。</p></li></ul><p><code>国内指定DNS</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server=/cn/114.114.114.114</span><br><span class="line">server=/taobao.com/114.114.114.114</span><br><span class="line">server=/taobaocdn.com/114.114.114.114</span><br></pre></td></tr></table></figure><p><code>国外指定DNS</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server=/google.com/223.5.5.5</span><br></pre></td></tr></table></figure><ul><li>屏蔽网页广告，将指广告的URL指定127这个IP，就可以将网页上讨厌的广告给去掉了。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">address=/ad.youku.com/127.0.0.1</span><br><span class="line">address=/ad.iqiyi.com/127.0.0.1</span><br></pre></td></tr></table></figure><ul><li>指定域名解析到特定的IP上。这个功能可以让你控制一些网站的访问，非法的DNS就经常把一些正规的网站解析到不正确IP上。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address=/freehao123.com/123.123.123.123</span><br></pre></td></tr></table></figure><ul><li>管理控制内网DNS，首先将局域网中的所有的设备的本地DNS设置为已经安装Dnsmasq的服务器IP地址。然后修改已经安装Dnsmasq的服务器Hosts文件：/etc/hosts，指定域名到特定的IP中。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">例如想让局域网中的所有用户访问www.freehao123.com时跳转到192.168.0.2，添加：192.168.0.2  www.freehao123.com在Hosts文件中既可，整个过程也可以说是“DNS劫持”</span><br></pre></td></tr></table></figure><br><h3 id="二、开始安装"><a href="#二、开始安装" class="headerlink" title="二、开始安装"></a>二、开始安装</h3><h4 id="2-1-安装服务"><a href="#2-1-安装服务" class="headerlink" title="2.1 安装服务"></a>2.1 安装服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install dnsmasq</span><br></pre></td></tr></table></figure><br><h4 id="2-2-配置文件"><a href="#2-2-配置文件" class="headerlink" title="2.2 配置文件"></a>2.2 配置文件</h4><ul><li>dnsmasq配置文件</li><li>vim  /etc/dnsmasq.conf</li></ul><p><code>dnsmasq有很多自定义的配置，此处我根据公司目前需求环境简化了很多，大家如果有兴趣的话，可以多去了解一下，或者直接参考本博客最后面额外补充的内容</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 指定上游DNS服务器</span><br><span class="line">resolv-file=/etc/resolv.dnsmasq.conf</span><br><span class="line"></span><br><span class="line"># 如果没有指定上游resolv.dnsmasq.conf配置文件的话，这里就可以开启 no-resolv</span><br><span class="line">#no-resolv </span><br><span class="line">#向所有上游服务器发送查询，而不是一个</span><br><span class="line">#all-servers</span><br><span class="line"></span><br><span class="line"># 记录dns查询日志，如果指定 log-queries=extra 那么在每行开始处都有额外的日志信息</span><br><span class="line">log-queries</span><br><span class="line">log-facility=/var/log/dnsmasq/dnsmasq.log</span><br><span class="line"></span><br><span class="line"># 不加载本地的 /etc/hosts 文件</span><br><span class="line">no-hosts</span><br><span class="line"># 重新指定本地hosts文件，用来保存所有的解析记录</span><br><span class="line">addn-hosts=/etc/dnsmasq.hosts</span><br><span class="line">cache-size=20000</span><br><span class="line">local-ttl=600</span><br><span class="line">dns-forward-max=20000</span><br></pre></td></tr></table></figure><br><ul><li>配置上游dns地址</li><li>vim  /etc/resolv.dnsmasq.conf</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 前面两个为公司内网AD域的dns地址，当dnsmasq解析不到的记录会丢给下面3个去解析，前两个ip是内网AD域DNS地址，可根据自己环境配置</span><br><span class="line">nameserver 10.1.100.xx</span><br><span class="line">nameserver 10.1.100.xx</span><br><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></table></figure><br><h4 id="2-3-服务启动"><a href="#2-3-服务启动" class="headerlink" title="2.3 服务启动"></a>2.3 服务启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl status  dnsmasq</span><br><span class="line">systemctl start   dnsmasq</span><br><span class="line">systemctl stop    dnsmasq</span><br><span class="line">systemctl restart dnsmasq</span><br></pre></td></tr></table></figure><br><h4 id="2-4-日志维护"><a href="#2-4-日志维护" class="headerlink" title="2.4 日志维护"></a>2.4 日志维护</h4><blockquote><p>内网解析量很多，每天产生大量日志，避免磁盘爆满影响服务，建议开启nscd缓存以及定时任务清理本地解析日志</p></blockquote><br><h5 id="2-41-安装nscd缓存"><a href="#2-41-安装nscd缓存" class="headerlink" title="2.41 安装nscd缓存"></a>2.41 安装nscd缓存</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install nscd -y</span><br><span class="line">service nscd start</span><br><span class="line"># 查看缓存统计信息</span><br><span class="line">nscd -g</span><br><span class="line"># 清除指定类型缓存</span><br><span class="line">nscd -i passwd</span><br><span class="line">nscd -i group</span><br><span class="line">nscd -i hosts</span><br></pre></td></tr></table></figure><br><h5 id="2-42-定时清理日志任务"><a href="#2-42-定时清理日志任务" class="headerlink" title="2.42 定时清理日志任务"></a>2.42 定时清理日志任务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 每周清理一次</span><br><span class="line">0 0 * * 0  &gt;/var/log/dnsmasq/dnsmasq.log</span><br></pre></td></tr></table></figure><br><h4 id="2-5-Dnsmasq服务测试"><a href="#2-5-Dnsmasq服务测试" class="headerlink" title="2.5 Dnsmasq服务测试"></a>2.5 Dnsmasq服务测试</h4><blockquote><p>本地解析记录保存在 <code>/etc/dnsmasq.hosts</code> 文件中，平时可以自己按照格式往里面添加解析记录，然后局域网dns地址全部指向此台dnsmasq的ip地址即可</p></blockquote><br><h5 id="2-51-新增解析记录"><a href="#2-51-新增解析记录" class="headerlink" title="2.51 新增解析记录"></a>2.51 新增解析记录</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 新增一条测试记录，ip + 空格 + 主机名</span><br><span class="line">172.17.17.100  ansible-host</span><br></pre></td></tr></table></figure><br><h5 id="2-52-客户端配置"><a href="#2-52-客户端配置" class="headerlink" title="2.52 客户端配置"></a>2.52 客户端配置</h5><blockquote><p>在局域网中找一台机器，修改本机resolv.conf中的dns解析地址为Dnsmasq地址，然后本机 <code>ping ansible-host</code> 看是否反馈的地址是 <code>172.17.17.100</code> 则服务配置成功</p></blockquote><ul><li>vim /etc/resolv.conf</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 这里search后面跟的内容会自动不全到解析记录里面（可选）</span><br><span class="line">search xx.xx.cn  </span><br><span class="line"># 下面这个ip指向Dnsmasq服务器的ip地址</span><br><span class="line">nameserver  xxx.xxx.xxx.xxx</span><br></pre></td></tr></table></figure><br><h3 id="三、额外补充配置介绍"><a href="#三、额外补充配置介绍" class="headerlink" title="三、额外补充配置介绍"></a>三、额外补充配置介绍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br></pre></td><td class="code"><pre><span class="line"># 不加载本地的 /etc/hosts 文件</span><br><span class="line"></span><br><span class="line"># no-hosts</span><br><span class="line"></span><br><span class="line"># 添加读取额外的 hosts 文件路径，可以多次指定。如果指定为目录，则读取目录中的所有文件。</span><br><span class="line"></span><br><span class="line"># addn-hosts=/etc/dnsmasq.hosts.d</span><br><span class="line"></span><br><span class="line"># 读取目录中的所有文件，文件更新将自动读取</span><br><span class="line"></span><br><span class="line"># hostsdir=/etc/dnsmasq.hosts.d</span><br><span class="line"></span><br><span class="line"># 例如,/etc/hosts中的os01将扩展成os01.example.com</span><br><span class="line"></span><br><span class="line"># expand-hosts</span><br><span class="line">##############################################################################</span><br><span class="line"># 缓存时间设置，一般不需要设置</span><br><span class="line"># 本地 hosts 文件的缓存时间，通常不要求缓存本地，这样更改hosts文件后就即时生效。</span><br><span class="line"></span><br><span class="line"># local-ttl=3600</span><br><span class="line"></span><br><span class="line"># 同 local-ttl 仅影响 DHCP 租约</span><br><span class="line"></span><br><span class="line"># dhcp-ttl=&lt;time&gt;</span><br><span class="line"></span><br><span class="line"># 对于上游返回的值没有ttl时，dnsmasq给一个默认的ttl，一般不需要设置，</span><br><span class="line"></span><br><span class="line"># neg-ttl=&lt;time&gt;</span><br><span class="line"></span><br><span class="line"># 指定返回给客户端的ttl时间，一般不需要设置</span><br><span class="line"></span><br><span class="line"># max-ttl=&lt;time&gt;</span><br><span class="line"></span><br><span class="line"># 设置在缓存中的条目的最大 TTL。</span><br><span class="line"></span><br><span class="line"># max-cache-ttl=&lt;time&gt;</span><br><span class="line"></span><br><span class="line"># 不需要设置，除非你知道你在做什么。</span><br><span class="line"></span><br><span class="line"># min-cache-ttl=&lt;time&gt;</span><br><span class="line"></span><br><span class="line"># 一般不需要设置</span><br><span class="line"></span><br><span class="line"># auth-ttl=&lt;time&gt;</span><br><span class="line">##############################################################################</span><br><span class="line"># 记录dns查询日志，如果指定 log-queries=extra 那么在每行开始处都有额外的日志信息。</span><br><span class="line"></span><br><span class="line"># log-queries</span><br><span class="line"></span><br><span class="line"># 设置日志记录器，&apos;-&apos; 为 stderr，也可以是文件路径。默认为：DAEMON，调试时使用 LOCAL0。</span><br><span class="line"></span><br><span class="line"># log-facility=&lt;facility&gt;</span><br><span class="line"></span><br><span class="line"># log-facility=/var/log/dnsmasq/dnsmasq.log</span><br><span class="line"></span><br><span class="line"># 异步log，缓解阻塞，提高性能。默认为5，最大100。</span><br><span class="line"></span><br><span class="line"># log-async[=&lt;lines&gt;]</span><br><span class="line"></span><br><span class="line"># log-async=50</span><br><span class="line">##############################################################################</span><br><span class="line"># 指定用户和组</span><br><span class="line"></span><br><span class="line"># user=nobody</span><br><span class="line"></span><br><span class="line"># group=nobody</span><br><span class="line">##############################################################################</span><br><span class="line"># 指定DNS的端口，默认53，设置 port=0 将完全禁用 DNS 功能，仅使用 DHCP/TFTP</span><br><span class="line"></span><br><span class="line"># port=53</span><br><span class="line"></span><br><span class="line"># 指定 EDNS.0 UDP 包的最大尺寸，默认为 RFC5625 推荐的 edns-packet-max=4096</span><br><span class="line"></span><br><span class="line"># edns-packet-max=&lt;size&gt;</span><br><span class="line"></span><br><span class="line"># 指定向上游查询的 UDP 端口，默认是随机端口，指定后降低安全性、加快速度、减少资源消耗。</span><br><span class="line"># 设置为 &apos;0&apos; 由操作系统分配。</span><br><span class="line"></span><br><span class="line"># query-port=53535</span><br><span class="line"></span><br><span class="line"># 指定向上游查询的 UDP 端口范围，方便防火墙设置。</span><br><span class="line"></span><br><span class="line"># min-port=&lt;port&gt;</span><br><span class="line"></span><br><span class="line"># max-port=&lt;port&gt;</span><br><span class="line"></span><br><span class="line"># 指定接口，指定后同时附加 lo 接口，可以使用&apos;*&apos;通配符。</span><br><span class="line"># 不能使用接口别名（例如：&quot;eth1:0&quot;），请用 listen-address 选项替代。</span><br><span class="line"></span><br><span class="line"># interface=wlp2s0</span><br><span class="line"></span><br><span class="line"># 指定排除的接口，排除优先级高，可以使用&apos;*&apos;通配符</span><br><span class="line"></span><br><span class="line"># except-interface=</span><br><span class="line"></span><br><span class="line"># 仅接受同一子网的 DNS 请求。</span><br><span class="line"># 仅在未指定 interface、except-interface、listen-address 或者 auth-server 时有效。</span><br><span class="line"></span><br><span class="line">#local-service</span><br><span class="line"></span><br><span class="line"># 指定不提供 DHCP 或 TFTP 服务的接口，仅提供 DNS 服务。</span><br><span class="line"></span><br><span class="line"># no-dhcp-interface=enp3s0</span><br><span class="line"></span><br><span class="line"># 指定IP地址，可以多次指定。</span><br><span class="line"># interface 选项和 listen-address 选项可以同时使用。</span><br><span class="line"># 下面两行与指定 interface 选项的作用类似。</span><br><span class="line"></span><br><span class="line">listen-address=192.168.10.17</span><br><span class="line"></span><br><span class="line"># listen-address=127.0.0.1</span><br><span class="line"></span><br><span class="line"># 通常情况下即使设置了 interface 选项（例如：interface=wlp2s0 ）</span><br><span class="line"># 将仍然绑定到通配符地址（例如：*:53 ）。</span><br><span class="line"># 开启此项将仅监听指定的接口。</span><br><span class="line"># 适用于在同一主机的不同接口或 IP 地址上运行多个 dns 服务器。</span><br><span class="line"></span><br><span class="line">bind-interfaces</span><br><span class="line"></span><br><span class="line"># 对于新添加的接口不进行绑定。仅 Linux 系统支持，其他系统等同于 bind-interfaces 选项。</span><br><span class="line"></span><br><span class="line"># bind-dynamic</span><br><span class="line">##############################################################################</span><br><span class="line"># 如果 hosts 中的主机有多个 IP 地址，仅返回对应子网的 IP 地址。</span><br><span class="line"></span><br><span class="line">localise-queries</span><br><span class="line"></span><br><span class="line"># 如果反向查找的是私有地址例如192.168.X.X，仅从 hosts 文件查找，不再转发到上游服务器</span><br><span class="line"></span><br><span class="line"># bogus-priv</span><br><span class="line"></span><br><span class="line"># 对于任何被解析到此 IP 的域名，将响应 NXDOMAIN 使其解析失效，可以多次指定</span><br><span class="line"># 通常用于对于访问不存在的域名，禁止其跳转到运营商的广告站点。</span><br><span class="line"></span><br><span class="line"># bogus-nxdomain=64.94.110.11</span><br><span class="line"></span><br><span class="line"># 忽略包含指定地址的 A 记录查询的回复。</span><br><span class="line"># 例如上游有台 dns 服务器伪造 www.baidu.com 的 IP 为 1.1.1.1 并且响应速度非常快。</span><br><span class="line"># 指定 ignore-address=1.1.1.1 可以忽略它的响应信息，</span><br><span class="line"># 从而等待 www.baidu.com 正确的查询结果。</span><br><span class="line"></span><br><span class="line"># ignore-address=&lt;ipaddr&gt;</span><br><span class="line"></span><br><span class="line">filterwin2k</span><br><span class="line">##############################################################################</span><br><span class="line"># 指定 resolv-file 文件路径，默认/etc/resolv.conf</span><br><span class="line"></span><br><span class="line"># resolv-file=/etc/resolv.conf</span><br><span class="line"></span><br><span class="line"># 不读取 resolv-file 来确定上游服务器</span><br><span class="line"></span><br><span class="line"># no-resolv</span><br><span class="line"></span><br><span class="line"># 在编译时需要启用 DBus 支持。</span><br><span class="line"></span><br><span class="line"># enable-dbus[=&lt;service-name&gt;]</span><br><span class="line"></span><br><span class="line"># 严格按照resolv.conf中的顺序进行查找</span><br><span class="line"></span><br><span class="line"># strict-order</span><br><span class="line"></span><br><span class="line"># 向所有上游服务器发送查询，而不是一个。</span><br><span class="line"></span><br><span class="line">all-servers</span><br><span class="line"></span><br><span class="line"># 启用转发循环检测</span><br><span class="line"></span><br><span class="line"># dns-loop-detect</span><br><span class="line">##############################################################################</span><br><span class="line"># 这项安全设置是拒绝解析包含私有 IP 地址的域名，</span><br><span class="line"># 这些IP地址包括如下私有地址范围：10.0.0.0/8、172.16.0.0/12、192.168.0.0/16。</span><br><span class="line"># 其初衷是要防止类似上游DNS服务器故意将某些域名解析成特定私有内网IP而劫持用户这样的安全***。</span><br><span class="line"># 直接在配置文件中注销 stop-dns-rebind 配置项从而禁用该功能。</span><br><span class="line"># 这个方法确实可以一劳永逸的解决解析内网 IP 地址的问题，</span><br><span class="line"># 但是我们也失去了这项安全保护的特性，所以在这里我不推荐这个办法。</span><br><span class="line"># 使用 rebind-domain-ok 进行特定配置，顾名思义该配置项可以有选择的忽略域名的 rebind 行为</span><br><span class="line"></span><br><span class="line">stop-dns-rebind</span><br><span class="line"></span><br><span class="line">rebind-localhost-ok</span><br><span class="line"></span><br><span class="line"># rebind-domain-ok=[&lt;domain&gt;]|[[/&lt;domain&gt;/[&lt;domain&gt;/]</span><br><span class="line"></span><br><span class="line">rebind-domain-ok=/.test.com/</span><br><span class="line">##############################################################################</span><br><span class="line"># 也不要检测 /etc/resolv.conf 的变化</span><br><span class="line"></span><br><span class="line"># no-poll</span><br><span class="line"></span><br><span class="line"># 重启后清空缓存</span><br><span class="line"></span><br><span class="line">clear-on-reload</span><br><span class="line"></span><br><span class="line"># 完整的域名才向上游服务器查找，如果仅仅是主机名仅查找hosts文件</span><br><span class="line"></span><br><span class="line">domain-needed</span><br><span class="line">##############################################################################</span><br><span class="line"># IP地址转换</span><br><span class="line"></span><br><span class="line"># alias=[&lt;old-ip&gt;]|[&lt;start-ip&gt;-&lt;end-ip&gt;],&lt;new-ip&gt;[,&lt;mask&gt;]</span><br><span class="line">##############################################################################</span><br><span class="line"># local=[/[&lt;domain&gt;]/[domain/]][&lt;ipaddr&gt;[#&lt;port&gt;][@&lt;source-ip&gt;|&lt;interface&gt;[#&lt;port&gt;]]</span><br><span class="line"></span><br><span class="line"># server=[/[&lt;domain&gt;]/[domain/]][&lt;ipaddr&gt;[#&lt;port&gt;][@&lt;source-ip&gt;|&lt;interface&gt;[#&lt;port&gt;]]</span><br><span class="line"></span><br><span class="line">server=/test.com/192.168.10.117</span><br><span class="line"></span><br><span class="line">server=/10.168.192.in-addr.arpa/192.168.10.117</span><br><span class="line"></span><br><span class="line"># rev-server=&lt;ip-address&gt;/&lt;prefix-len&gt;,&lt;ipaddr&gt;[#&lt;port&gt;][@&lt;source-ip&gt;|&lt;interface&gt;[#&lt;port&gt;]]</span><br><span class="line"></span><br><span class="line"># 将任何属于 &lt;domain&gt; 域名解析成指定的 &lt;ipaddr&gt; 地址。</span><br><span class="line"># 也就是将 &lt;domain&gt; 及其所有子域名解析成指定的 &lt;ipaddr&gt; IPv4 或者 IPv6 地址，通常用于屏蔽特定的域名。</span><br><span class="line"># 一次只能指定一个 IPv4 或者 IPv6 地址，要同时返回 IPv4 和IPv6 地址，请多次指定 address= 选项。</span><br><span class="line"># 注意： /etc/hosts 以及 DHCP 租约将覆盖此项设置。</span><br><span class="line"></span><br><span class="line"># address=/&lt;domain&gt;/[domain/][&lt;ipaddr&gt;]</span><br><span class="line"></span><br><span class="line"># ipset=/&lt;domain&gt;/[domain/]&lt;ipset&gt;[,&lt;ipset&gt;]</span><br><span class="line"></span><br><span class="line"># mx-host=&lt;mx name&gt;[[,&lt;hostname&gt;],&lt;preference&gt;]</span><br><span class="line"></span><br><span class="line"># mx-target=&lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"># SRV 记录</span><br><span class="line"></span><br><span class="line"># srv-host=&lt;_service&gt;.&lt;_prot&gt;.[&lt;domain&gt;],[&lt;target&gt;[,&lt;port&gt;[,&lt;priority&gt;[,&lt;weight&gt;]]]]</span><br><span class="line"></span><br><span class="line"># A, AAAA 和 PTR 记录 </span><br><span class="line"></span><br><span class="line"># host-record=&lt;name&gt;[,&lt;name&gt;....],[&lt;IPv4-address&gt;],[&lt;IPv6-address&gt;][,&lt;TTL&gt;]</span><br><span class="line"></span><br><span class="line"># TXT 记录</span><br><span class="line"></span><br><span class="line"># txt-record=&lt;name&gt;[[,&lt;text&gt;],&lt;text&gt;]</span><br><span class="line"></span><br><span class="line"># PTR 记录 </span><br><span class="line"></span><br><span class="line"># ptr-record=&lt;name&gt;[,&lt;target&gt;]</span><br><span class="line"></span><br><span class="line"># naptr-record=&lt;name&gt;,&lt;order&gt;,&lt;preference&gt;,&lt;flags&gt;,&lt;service&gt;,&lt;regexp&gt;[,&lt;replacement&gt;]</span><br><span class="line"></span><br><span class="line"># CNAME 别名记录</span><br><span class="line"></span><br><span class="line"># cname=&lt;cname&gt;,&lt;target&gt;[,&lt;TTL&gt;]</span><br><span class="line"></span><br><span class="line"># dns-rr=&lt;name&gt;,&lt;RR-number&gt;,[&lt;hex data&gt;]</span><br><span class="line"></span><br><span class="line"># interface-name=&lt;name&gt;,&lt;interface&gt;[/4|/6]</span><br><span class="line"></span><br><span class="line"># synth-domain=&lt;domain&gt;,&lt;address range&gt;[,&lt;prefix&gt;]</span><br><span class="line"></span><br><span class="line"># add-mac[=base64|text]</span><br><span class="line"></span><br><span class="line"># add-cpe-id=&lt;string&gt;</span><br><span class="line"></span><br><span class="line"># add-subnet[[=[&lt;IPv4 address&gt;/]&lt;IPv4 prefix length&gt;][,[&lt;IPv6 address&gt;/]&lt;IPv6 prefix length&gt;]]</span><br><span class="line">##############################################################################</span><br><span class="line">##############################################################################</span><br><span class="line"># 缓存条数，默认为150条，cache-size=0 禁用缓存。</span><br><span class="line"></span><br><span class="line">cache-size=1000</span><br><span class="line"></span><br><span class="line"># 不缓存未知域名缓存，默认情况下dnsmasq缓存未知域名并直接返回为客户端。</span><br><span class="line"></span><br><span class="line">no-negcache</span><br><span class="line"></span><br><span class="line"># 指定DNS同属查询转发数量</span><br><span class="line"></span><br><span class="line">dns-forward-max=1000</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line">#        DHCP 选项</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># 设置 DHCP 地址池，同时启用 DHCP 功能。</span><br><span class="line"># IPv4 &lt;mode&gt; 可指定为 static|proxy ，当 &lt;mode&gt; 指定为 static 时，</span><br><span class="line"># 需用 dhcp-host 手动分配地址池中的 IP 地址。</span><br><span class="line"># 当 &lt;mode&gt; 指定为 proxy 时，为指定的地址池提供 DHCP 代理。</span><br><span class="line"></span><br><span class="line"># dhcp-range=[tag:&lt;tag&gt;[,tag:&lt;tag&gt;],][set:&lt;tag&gt;,]&lt;start-addr&gt;[,&lt;end-addr&gt;][,&lt;mode&gt;][,&lt;netmask&gt;[,&lt;broadcast&gt;]][,&lt;lease time&gt;]</span><br><span class="line"></span><br><span class="line"># dhcp-range=172.16.0.2,172.16.0.250,255.255.255.0,1h</span><br><span class="line"></span><br><span class="line"># dhcp-range=192.168.10.150,192.168.10.180,static,255.255.255.0,1h</span><br><span class="line"></span><br><span class="line"># 根据 MAC 地址或 id 固定分配客户端的 IP 地址、主机名、租期。</span><br><span class="line"></span><br><span class="line"># IPv4 下指定 id:* 将忽略 DHCP 客户端的 ID ，仅根据 MAC 来进行 IP 地址分配。</span><br><span class="line"></span><br><span class="line"># 在读取 /etc/hosts 的情况，也可以根据 /etc/hosts 中的主机名分配对应 IP 地址。</span><br><span class="line"></span><br><span class="line"># 指定 ignore 将忽略指定客户端得 DHCP 请求。</span><br><span class="line"></span><br><span class="line"># dhcp-host=[&lt;hwaddr&gt;][,id:&lt;client_id&gt;|*][,set:&lt;tag&gt;][,&lt;ipaddr&gt;][,&lt;hostname&gt;][,&lt;lease_time&gt;][,ignore]</span><br><span class="line"></span><br><span class="line"># dhcp-hostsfile=&lt;path&gt;</span><br><span class="line"></span><br><span class="line"># dhcp-hostsdir=&lt;path&gt;</span><br><span class="line"></span><br><span class="line"># 读取 /etc/ethers 文件 与使用 dhcp-host 的作用相同。IPv6 无效。</span><br><span class="line"></span><br><span class="line"># read-ethers</span><br><span class="line"></span><br><span class="line"># 指定给 DHCP 客户端的选项信息，</span><br><span class="line"># 默认情况下 dnsmasq 将发送：子网掩码、广播地址、DNS 服务器地址、网关地址、域等信息。</span><br><span class="line"># 指定此选项也可覆盖这些默认值并且设置其他选项值。</span><br><span class="line"># 重要：可以使用 option:&lt;option-name&gt;或者 option号 来指定。</span><br><span class="line"></span><br><span class="line"># &lt;option-name&gt; 和 option号的对应关系可使用命令：</span><br><span class="line"></span><br><span class="line"># dnsmasq --help dhcp 以及 dnsmasq --help dhcp6 查看，这点很重要。</span><br><span class="line"></span><br><span class="line"># 例如设置网关参数，既可以使用 dhcp-option=3,192.168.4.4 也可以使用 dhcp-option = option:router,192.168.4.4。</span><br><span class="line"></span><br><span class="line"># 0.0.0.0 意味着当前运行 dnsmasq 的主机地址。</span><br><span class="line"></span><br><span class="line"># 如果指定了多个 tag:&lt;tag&gt; 必须同时匹配才行。</span><br><span class="line"></span><br><span class="line"># [encap:&lt;opt&gt;,][vi-encap:&lt;enterprise&gt;,][vendor:[&lt;vendor-class&gt;],] 有待继续研究。</span><br><span class="line"></span><br><span class="line"># dhcp-option=[tag:&lt;tag&gt;,[tag:&lt;tag&gt;,]][encap:&lt;opt&gt;,][vi-encap:&lt;enterprise&gt;,][vendor:[&lt;vendor-class&gt;],][&lt;opt&gt;|option:&lt;opt-name&gt;|option6:&lt;opt&gt;|option6:&lt;opt-name&gt;],[&lt;value&gt;[,&lt;value&gt;]]</span><br><span class="line"></span><br><span class="line"># dhcp-option-force=[tag:&lt;tag&gt;,[tag:&lt;tag&gt;,]][encap:&lt;opt&gt;,][vi-encap:&lt;enterprise&gt;,][vendor:[&lt;vendor-class&gt;],]&lt;opt&gt;,[&lt;value&gt;[,&lt;value&gt;]]</span><br><span class="line"></span><br><span class="line"># dhcp-optsfile=&lt;path&gt;</span><br><span class="line"></span><br><span class="line"># dhcp-optsdir=&lt;path&gt;</span><br><span class="line"></span><br><span class="line"># dhcp-option=3,1.2.3.4</span><br><span class="line"></span><br><span class="line"># dhcp-option=option:router,1.2.3.4</span><br><span class="line"></span><br><span class="line"># dhcp-option=option:router,192.168.10.254</span><br><span class="line"></span><br><span class="line"># dhcp-option=option:dns-server,192.168.10.254,221.12.1.227,221.12.33.227</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"># (IPv4 only) 禁用重用服务器名称和文件字段作为额外的 dhcp-option 选项。</span><br><span class="line"># 一般情况下 dnsmasq 从 dhcp-boot 移出启动服务器和文件信息到 dhcp-option 选项中。</span><br><span class="line"># 这使得在 dhcp-option 选项封包中有额外的选项空间可用，但是会使老的客户端混淆。</span><br><span class="line"># 此选项将强制使用简单并安全的方式来避免此类情况。可以认为是一个兼容性选项。</span><br><span class="line"></span><br><span class="line">#dhcp-no-override</span><br><span class="line">##############################################################################</span><br><span class="line"># DHCP 使用客户端的 MAC 地址的哈希值为客户端分配 IP 地址，</span><br><span class="line"># 通常情况下即使客户端使自己的租约到期，客户端的 IP 地址仍将长期保持稳定。</span><br><span class="line"># 在默认模式下，IP 地址是随机分配的。</span><br><span class="line"># 启用 dhcp-sequential-ip 选项将按顺序分配 IP 地址。</span><br><span class="line"># 在顺序分配模式下，客户端使租约到期更像是仅仅移动一下 IP 地址。</span><br><span class="line"># 在通常情况下不建议使用这种方式。</span><br><span class="line"></span><br><span class="line"># dhcp-sequential-ip</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line"># 默认为150，即最多分配150个ip地址出去，最大1000个ip</span><br><span class="line"></span><br><span class="line"># dhcp-lease-max=150</span><br><span class="line"></span><br><span class="line"># (IPv4 only) 指定DHCP端口，默认为67和68。如果不指定则为1067和1068，单指定一个，第二个加1</span><br><span class="line"></span><br><span class="line"># dhcp-alternate-port[=&lt;server port&gt;[,&lt;client port&gt;]]</span><br><span class="line"></span><br><span class="line"># 谨慎使用此选项，避免 IP 地址浪费。(IPv4 only) 允许动态分配 IP 地址给 BOOTP 客户端。</span><br><span class="line"># 注意：BOOTP 客户端获取的 IP 地址是永久的，将无法再次分配给其他客户端。</span><br><span class="line"></span><br><span class="line"># bootp-dynamic[=&lt;network-id&gt;[,&lt;network-id&gt;]]</span><br><span class="line"></span><br><span class="line"># 谨慎使用此选项。</span><br><span class="line"># 默认情况下 DHCP 服务器使用 ping 的方式进行确保 IP 未被使用的情况下将 IP 地址分配出去。</span><br><span class="line"># 启用此选项将不使用 ping 进行确认。</span><br><span class="line"></span><br><span class="line"># no-ping</span><br><span class="line">##############################################################################</span><br><span class="line"># 记录额外的 dhcp 日志，记录所有发送给 DHCP 客户端的选项（option）以及标签（tag）信息</span><br><span class="line"></span><br><span class="line"># log-dhcp</span><br><span class="line"></span><br><span class="line"># 禁止记录日常操作日志，错误日志仍然记录。启用 log-dhcp 将覆盖下列选项。</span><br><span class="line"></span><br><span class="line"># quiet-dhcp</span><br><span class="line"></span><br><span class="line"># quiet-dhcp6</span><br><span class="line"></span><br><span class="line"># quiet-ra</span><br><span class="line"></span><br><span class="line"># 修改 DHCP 默认租约文件路径，默认情况下无需修改</span><br><span class="line"></span><br><span class="line"># dhcp-leasefile=/var/lib/dnsmasq/dnsmasq.leases</span><br><span class="line"></span><br><span class="line"># (IPv6 only)</span><br><span class="line"></span><br><span class="line"># dhcp-duid=&lt;enterprise-id&gt;,&lt;uid&gt;</span><br><span class="line">##############################################################################</span><br><span class="line"># dhcp-script=&lt;path&gt;</span><br><span class="line"></span><br><span class="line"># dhcp-luascript=&lt;path&gt;</span><br><span class="line"></span><br><span class="line"># dhcp-scriptuser=root</span><br><span class="line"></span><br><span class="line"># script-arp</span><br><span class="line"></span><br><span class="line"># leasefile-ro</span><br><span class="line"></span><br><span class="line"># bridge-interface=&lt;interface&gt;,&lt;alias&gt;[,&lt;alias&gt;]</span><br><span class="line">##############################################################################</span><br><span class="line"># 给 DHCP 服务器指定 domain 域名信息，也可以给对应的 IP 地址池指定域名。</span><br><span class="line"># 直接指定域名</span><br><span class="line"></span><br><span class="line"># 示例：domain=thekelleys.org.uk</span><br><span class="line"></span><br><span class="line"># 子网对应的域名</span><br><span class="line"></span><br><span class="line"># 示例：domain=wireless.thekelleys.org.uk,192.168.2.0/24</span><br><span class="line"></span><br><span class="line"># ip范围对应的域名</span><br><span class="line"></span><br><span class="line"># 示例：domain=reserved.thekelleys.org.uk,192.68.3.100,192.168.3.200</span><br><span class="line"></span><br><span class="line"># domain=&lt;domain&gt;[,&lt;address range&gt;[,local]]</span><br><span class="line"></span><br><span class="line"># 在默认情况下 dnsmasq 插入普通的客户端主机名到 DNS 中。</span><br><span class="line"># 在这种情况下主机名必须唯一，即使两个客户端具有不同的域名后缀。</span><br><span class="line"># 如果第二个客户端使用了相同的主机名，DNS 查询将自动更新为第二个客户端的 IP 地址。</span><br><span class="line"># 如果设置了 dhcp-fqdn 选项，普通的主机名将不再插入到 DNS 中去，</span><br><span class="line"># 仅允许合格的具有域名后缀的主机名插入到 DNS 服务器中。</span><br><span class="line"># 指定此选项需同时指定不含 &lt;address range&gt; 地址范围的 domain 选项。</span><br><span class="line"></span><br><span class="line">#dhcp-fqdn</span><br><span class="line"></span><br><span class="line"># 通常情况下分配 DHCP 租约后，dnsmasq 设置 FQDN 选项告诉客户端不要尝试 DDNS 更新主机名与 IP 地址。</span><br><span class="line"># 这是因为  name-IP 已自动添加到 dnsmasq 的 DNS 视图中的。</span><br><span class="line"># 设置此选项将允许客户端 DDNS 更新，</span><br><span class="line"># 在 windows 下允许客户端更新 windows AD 服务器是非常有用的。</span><br><span class="line"># 参看  RFC 4702</span><br><span class="line"></span><br><span class="line"># dhcp-client-update</span><br><span class="line"># enable-ra</span><br><span class="line"># ra-param=&lt;interface&gt;,[high|low],[[&lt;ra-interval&gt;],&lt;router lifetime&gt;]</span><br><span class="line"></span><br><span class="line">##############################################################################</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">#        TFTP 选项</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">##############################################################################</span><br><span class="line"># 对于绝大多数的配置，仅需指定 enable-tftp 和 tftp-root 选项即可。</span><br><span class="line"># 是否启用内置的 tftp 服务器，可以指定多个逗号分隔的网络接口</span><br><span class="line"></span><br><span class="line"># enable-tftp[=&lt;interface&gt;[,&lt;interface&gt;]]</span><br><span class="line"></span><br><span class="line"># enable-tftp</span><br><span class="line"></span><br><span class="line"># enable-tftp=enp3s0,lo</span><br><span class="line"></span><br><span class="line"># 指定 tftp 的根目录，也就是寻找传输文件时使用的相对路径，可以附加接口，</span><br><span class="line"></span><br><span class="line"># tftp-root=&lt;directory&gt;[,&lt;interface&gt;]</span><br><span class="line"></span><br><span class="line"># tftp-root=/var/lib/tftpboot/</span><br><span class="line"></span><br><span class="line"># 如果取消注释，那么即使指定的 tftp-root 无法访问，仍然启动 tftp 服务。</span><br><span class="line"></span><br><span class="line"># tftp-no-fail</span><br><span class="line"></span><br><span class="line"># 附加客户端的 IP 地址作为文件路径。此选项仅在正确设置了 tftp-root 的情况下可用，</span><br><span class="line"># 示例：如果 tftp-root=/tftp，客户端为 192.168.1.15 请求 myfile.txt 文件时，</span><br><span class="line"># 将优先请求 /tftp/192.168.1.15/myfile.txt 文件， 其次是 /tftp/myfile.txt 文件。</span><br><span class="line"># 感觉没什么用。</span><br><span class="line"></span><br><span class="line"># tftp-unique-root</span><br><span class="line"></span><br><span class="line"># 启用安全模式，启用此选项，仅允许 tftp 进程访问属主为自己的文件。</span><br><span class="line"># 不启用此选项，允许访问所有 tftp 进程属主可读取的文件。</span><br><span class="line"># 如果 dnsmasq 是以 root 用户运行，tftp-secure 选项将允许访问全局可读的文件。</span><br><span class="line"># 一般情况下不推荐以 root 用户运行 dnsmasq。</span><br><span class="line"># 在指定了 tftp-root 的情况下并不是很重要。</span><br><span class="line"></span><br><span class="line"># tftp-secure</span><br><span class="line"></span><br><span class="line"># 将所有文件请求转换为小写。对于 Windows 客户端来说非常有用，建议开启此项。</span><br><span class="line"># 注意：dnsmasq 的 TFTP 服务器总是将文件路径中的“\”转换为“/”。</span><br><span class="line"></span><br><span class="line"># tftp-lowercase</span><br><span class="line"></span><br><span class="line"># 允许最大的连接数，默认为 50</span><br><span class="line"># 如果将连接数设置的很大，需注意每个进程的最大文件描述符限制，详见文档手册。</span><br><span class="line"></span><br><span class="line"># tftp-max=&lt;connections&gt;</span><br><span class="line"></span><br><span class="line"># tftp-max=50</span><br><span class="line"></span><br><span class="line"># 设置传输时的 MTU 值，建议不设置或按需设置。</span><br><span class="line"># 如果设定的值大于网络接口的 MTU 值，将按照网络接口的 MTU 值自动分片传输（不推荐）。</span><br><span class="line"></span><br><span class="line"># tftp-mtu=&lt;mtu size&gt;</span><br><span class="line"></span><br><span class="line"># 停止 tftp 服务器与客户端协商 &quot;blocksize&quot; 选项。启用后，防止一些古怪的客户端出问题。</span><br><span class="line"></span><br><span class="line"># tftp-no-blocksize</span><br><span class="line"></span><br><span class="line"># 指定 tftp 的连接端口的范围，方便防火墙部署。</span><br><span class="line"># tftp 侦听在 69/udp ，连接端口默认是由系统自动分配的，</span><br><span class="line"># 非 root 用户运行时指定的连接端口号需大于 1025 最大 65535。</span><br><span class="line"></span><br><span class="line"># tftp-port-range=&lt;start&gt;,&lt;end&gt;</span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line"></span><br><span class="line"># conf-dir=&lt;directory&gt;[,&lt;file-extension&gt;......]</span><br><span class="line"></span><br><span class="line"># conf-file=/etc/dnsmasq.more.conf</span><br><span class="line"></span><br><span class="line">conf-dir=/etc/dnsmasq.d</span><br><span class="line"></span><br><span class="line"># servers-file=&lt;file&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux 运维 </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python脚本抓取腾讯云上主机名称及对应IP</title>
      <link href="/2019/10/05/script-gethostip/"/>
      <url>/2019/10/05/script-gethostip/</url>
      
        <content type="html"><![CDATA[<h3 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h3><ul><li><p>现在要求通过api接口，把腾讯云上所有的主机实例名称和对应内网ip地址抓取下来保存到dnsmasq文件中，供内部解析使用</p><a id="more"></a></li><li><p>公司内部有自己搭建的DNSMasq集群，用来解析主机名及对应IP。因为几千台机器，管理时大家都是通过主机名来区别什么服务,前提是每台主机命名要符合规范</p></li></ul><br><h3 id="二、脚本"><a href="#二、脚本" class="headerlink" title="二、脚本"></a>二、脚本</h3><h4 id="2-1-python脚本"><a href="#2-1-python脚本" class="headerlink" title="2.1 python脚本"></a>2.1 python脚本</h4><ul><li>Vim /root/python/GetDNS.py </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/env python3</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">from tencentcloud.common import credential</span><br><span class="line">from tencentcloud.common.exception.tencent_cloud_sdk_exception import TencentCloudSDKException</span><br><span class="line">from tencentcloud.cvm.v20170312 import cvm_client, models</span><br><span class="line"></span><br><span class="line">#HOST_FILE=&quot;/etc/dnsmasq.hosts&quot;</span><br><span class="line">#if os.path.exists(HOST_FILE):</span><br><span class="line">#    pass</span><br><span class="line">#else:</span><br><span class="line">#    print(&quot;没有发现DNS FILE，将会创建！&quot;)</span><br><span class="line">#    os.system(&quot;touch /etc/dnsmasq.hosts&quot;)</span><br><span class="line">def get_exist():</span><br><span class="line">    exist_ip = []</span><br><span class="line">    if not os.path.exists(&apos;/etc/dnsmasq.hosts&apos;):</span><br><span class="line">        return exist_ip</span><br><span class="line">    with open(&apos;/etc/dnsmasq.hosts&apos;, &apos;r&apos;) as f:</span><br><span class="line">        for data in f.readlines():</span><br><span class="line">            exist_ip.append(data.strip().split(&apos; &apos;)[0])</span><br><span class="line">    return exist_ip</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">def add_data():</span><br><span class="line">    secretId = &apos;AxxxxxxxxxxxxxxxxA&apos;    </span><br><span class="line">    secretKey = &apos;keyxxxxxxxxxxxxxxxxxxxxKEY&apos;  //此处填写腾讯云账户里面的ID及对应的KEY</span><br><span class="line">    cred = credential.Credential(secretId=secretId, secretKey=secretKey)</span><br><span class="line">    client = cvm_client.CvmClient(cred, &quot;ap-shanghai&quot;)</span><br><span class="line">    req = models.DescribeInstancesRequest()</span><br><span class="line">    resp = client.DescribeInstances(req)</span><br><span class="line">    exist_ip = get_exist()</span><br><span class="line">    for i in range(int(resp.TotalCount / 20) + 1):</span><br><span class="line">        req.Offset = i * 20</span><br><span class="line">        resp = client.DescribeInstances(req)</span><br><span class="line">        for j in resp.InstanceSet:</span><br><span class="line">            if j.PrivateIpAddresses[0] in exist_ip:</span><br><span class="line">                continue</span><br><span class="line">            line = &apos;&#123;&#125; &#123;&#125;.ad.tuhu.cn&apos;.format(j.PrivateIpAddresses[0], j.InstanceName)</span><br><span class="line">            #line = &apos;&#123;&#125; &#123;&#125;&apos;.format(j.PrivateIpAddresses[0], j.InstanceName)</span><br><span class="line">            with open(&apos;/etc/dnsmasq.hosts&apos;, &apos;a+&apos;) as f:</span><br><span class="line">                f.write(line + &apos;\n&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    add_data()</span><br></pre></td></tr></table></figure><br><h4 id="2-2-定时任务"><a href="#2-2-定时任务" class="headerlink" title="2.2 定时任务"></a>2.2 定时任务</h4><ul><li>本脚本每一分钟会去云上抓取一次解析记录，保存的记录是增量的，发现腾讯云上新建机器，则会把新纪录保存到本地<code>hosts</code>文件中，如果云上机器名称变更掉，则本地会有两条记录（同一个ip会对应两个主机名，解决方法可以清空本地解析记录，让脚本自动重新跑一次）</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/1  * * * * echo `date`&gt;&gt;/var/log/dnsmasq/getlist.log &amp;&amp; python /root/python/GetDNS.py  &gt;&gt;/var/log/dnsmasq/getlist.log</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 脚本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux 运维 </tag>
            
            <tag> 脚本 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tengine日常操作攻略</title>
      <link href="/2019/09/28/tenine-operation/"/>
      <url>/2019/09/28/tenine-operation/</url>
      
        <content type="html"><![CDATA[<h3 id="一、常用操作"><a href="#一、常用操作" class="headerlink" title="一、常用操作"></a>一、常用操作</h3><h4 id="1-1-重定向"><a href="#1-1-重定向" class="headerlink" title="1.1 重定向"></a>1.1 重定向</h4><ul><li>302 临时重定向</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /query &#123;</span><br><span class="line">          rewrite ^(.*)$  https://docs.qq.com/doc/DVEtQbVdOcUpTZWl2 redirect;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><a id="more"></a><ul><li>301 永久重定向</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /ceshi &#123;</span><br><span class="line">          rewrite ^(.*)$  https://$host$1 permanent;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><br><h4 id="1-2-配置返回403"><a href="#1-2-配置返回403" class="headerlink" title="1.2 配置返回403"></a>1.2 配置返回403</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /abcd &#123;</span><br><span class="line">         return 403;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ul><li>if嵌套语句返回403</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set $flag 0;</span><br><span class="line">if ($args ~* &quot;occupyStock&quot;) &#123;</span><br><span class="line">    set $flag &quot;$&#123;flag&#125;1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">if ($flag = &quot;01&quot;) &#123;</span><br><span class="line">    return 403;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br><h4 id="1-3-拒绝全部访问"><a href="#1-3-拒绝全部访问" class="headerlink" title="1.3 拒绝全部访问"></a>1.3 拒绝全部访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /configs/ &#123;</span><br><span class="line">         deny all;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><br><h4 id="1-4-拒绝某一个IP"><a href="#1-4-拒绝某一个IP" class="headerlink" title="1.4 拒绝某一个IP"></a>1.4 拒绝某一个IP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">       deny 125.119.249.65;</span><br><span class="line">       allow all;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><br><h4 id="1-5-代理"><a href="#1-5-代理" class="headerlink" title="1.5 代理"></a>1.5 代理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location /thirdparty &#123;</span><br><span class="line">       proxy_redirect off;</span><br><span class="line">       proxy_set_header Host www.512book.cn;</span><br><span class="line">       proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">       proxy_pass http://www.512book.cn/thirtparty;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><br><h4 id="1-6-Upstream健康检查模块"><a href="#1-6-Upstream健康检查模块" class="headerlink" title="1.6 Upstream健康检查模块"></a>1.6 Upstream健康检查模块</h4><ul><li>tcp协议，适用于后端是linux主机</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> upstream  www_512book_cn &#123;</span><br><span class="line">    keepalive 32;</span><br><span class="line">    keepalive_timeout 30s;</span><br><span class="line">    check interval=1000 rise=2 fall=3 timeout=1000 type=tcp;</span><br><span class="line">    check_keepalive_requests 10000;</span><br><span class="line">    server 10.10.12.19:8797;</span><br><span class="line">    server 10.10.12.37:8797;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>http协议，适用于后端是winserver web站点服务</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">upstream  www_512book_cn &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    keepalive 32;</span><br><span class="line">    keepalive_timeout 30s;</span><br><span class="line">    check interval=3000 rise=2 fall=3 timeout=1000 type=http default_down=false;</span><br><span class="line">    check_http_send &quot;GET /_stats/build.txt HTTP/1.1\r\nHost: localhost\r\nConnection: keep-alive\r\n\r\n&quot;;</span><br><span class="line">    check_keepalive_requests 10000;</span><br><span class="line">    server 10.10.12.19:8797;</span><br><span class="line">    server 10.10.12.37:8797;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h4 id="1-7-Server配置文件一份"><a href="#1-7-Server配置文件一份" class="headerlink" title="1.7 Server配置文件一份"></a>1.7 Server配置文件一份</h4>]]></content>
      
      
      <categories>
          
          <category> 负载均衡 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tengine </tag>
            
            <tag> 负载均衡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cisco asa防火墙与深信服设备打通IPsec-VPN</title>
      <link href="/2019/09/28/cisco-asa-sangfor/"/>
      <url>/2019/09/28/cisco-asa-sangfor/</url>
      
        <content type="html"><![CDATA[<h3 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h3><ul><li>为了实现北京分部能够和苏州总部内部局域网互通，先通过两边的设备打通<code>IPSEC</code> 点到点VPN隧道</li><li>设备：Cisco asa 5545（总部）、深信服SG设备（北京）</li></ul><a id="more"></a><br><h3 id="二、配置Cisco-asa防火墙"><a href="#二、配置Cisco-asa防火墙" class="headerlink" title="二、配置Cisco asa防火墙"></a>二、配置Cisco asa防火墙</h3><h4 id="2-1-建立地址对象"><a href="#2-1-建立地址对象" class="headerlink" title="2.1 建立地址对象"></a>2.1 建立地址对象</h4><blockquote><ul><li>苏州总部的三个网段109、110、111</li><li>北京的网段30网段</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">object network sz-109</span><br><span class="line"> subnet 192.168.109.0 255.255.255.0</span><br><span class="line">object network sz-110</span><br><span class="line"> subnet 192.168.110.0 255.255.255.0</span><br><span class="line">object network sz-172</span><br><span class="line"> subnet 172.16.5.0 255.255.255.0</span><br><span class="line">object network beijinglan</span><br><span class="line"> subnet 192.168.1.0 255.255.255.0  --北京分部网段</span><br></pre></td></tr></table></figure><blockquote><ul><li>建立一个组<code>SZ-VPN-BJ</code>，把上面的苏州总部三个网段添加进去，NAT转换的时候可以直接调用此组对象</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">object-group network SZ-VPN-BJ   </span><br><span class="line">   network-object object sz-109</span><br><span class="line">   network-object object sz-110</span><br><span class="line">   network-object object sz-172</span><br></pre></td></tr></table></figure><br><h4 id="2-2-创建Access-list访问列表"><a href="#2-2-创建Access-list访问列表" class="headerlink" title="2.2 创建Access-list访问列表"></a>2.2 创建Access-list访问列表</h4><blockquote><ul><li>允许苏州网段访问北京网段</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access-list outside_cryptomap extended permit ip object-group SZ-VPN-BJ  object beijinglan</span><br></pre></td></tr></table></figure><br><h4 id="2-3-Nat转换"><a href="#2-3-Nat转换" class="headerlink" title="2.3 Nat转换"></a>2.3 Nat转换</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nat (inside,outside) source static  SZ-VPN-BJ  SZ-VPN-BJ  destination  static  beijinglan  beijinglan  no-proxy-arp  route-lookup</span><br></pre></td></tr></table></figure><br><h4 id="2-4-配置第一阶段ikev1"><a href="#2-4-配置第一阶段ikev1" class="headerlink" title="2.4 配置第一阶段ikev1"></a>2.4 配置第一阶段ikev1</h4><blockquote><ul><li>Cisco asa 8.4（2）版本及以上的ASA支持2个版本的IKE，在此处我们选择IKEV1</li><li>创建一个策略名为120,定义两边共同的协商算法</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">crypto ikev1 policy 10                                    -------------</span><br><span class="line">   authentication pre-share</span><br><span class="line">   encryption 3des</span><br><span class="line">   hash sha</span><br><span class="line">   group 2</span><br><span class="line">   lifetime 28800</span><br></pre></td></tr></table></figure><blockquote><ul><li>配置一个静态VPN对等项和预共用的键的一个隧道组</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tunnel-group 118.186.xx.xx type ipsec-l2l   --118.186为北京分部IP</span><br><span class="line">tunnel-group 118.186.xx.xx ipsec-attributes</span><br><span class="line">   ikev1 pre-shared-key   woshibook    --配置一个公钥</span><br></pre></td></tr></table></figure><blockquote><ul><li>创建crypto map </li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">crypto ipsec ikev1 transform-set office  esp-3des esp-md5-hmac </span><br><span class="line">crypto map outside_map 10 match address outside_cryptomap   ------调用访问列表</span><br><span class="line">crypto map outside_map 10 set pfs </span><br><span class="line">crypto map outside_map 10 set peer  118.186.xx.xx           ------对端北京地址</span><br><span class="line">crypto map outside_map 10 set ikev1 transform-set office</span><br><span class="line">crypto map outside_map interface outside     --------------在outside接口启用ipsecvpn</span><br><span class="line">crypto ikev1 enable outside</span><br></pre></td></tr></table></figure><br><h3 id="三、分部深信服SG配置"><a href="#三、分部深信服SG配置" class="headerlink" title="三、分部深信服SG配置"></a>三、分部深信服SG配置</h3><h4 id="3-1-VPN配置"><a href="#3-1-VPN配置" class="headerlink" title="3.1 VPN配置"></a>3.1 VPN配置</h4><blockquote><p>-菜单中找到<code>VPN配置</code></p></blockquote><p><img src="https://i.loli.net/2019/09/28/fIYNWCjh9txad21.png" alt="image.png"></p><blockquote><ul><li>点击第一阶段<code>新增</code></li></ul></blockquote><p><img src="https://i.loli.net/2019/09/28/hdMWNYQlwcVI1qJ.png" alt="image.png"></p><blockquote><p>-填写对端固定ip及共享秘钥（跟总部asa对端保持一致）</p></blockquote><p><img src="https://i.loli.net/2019/09/28/7dZ9vXfxS1pksBt.png" alt="image.png"><br><img src="https://i.loli.net/2019/09/28/hz1ceWFPrMQZE47.png" alt="image.png"><br><img src="https://i.loli.net/2019/09/28/q7hP36xMmKzYaB4.png" alt="image.png"></p><blockquote><ul><li>菜单中点击<code>第二阶段</code>，配置<code>入站</code>和<code>出站</code>策略：</li></ul></blockquote><ul><li><code>先配置一个苏州总部的172网段的入站策略</code></li></ul><p><img src="https://i.loli.net/2019/09/28/kAj6S1g2RmHUnyF.png" alt="image.png"></p><ul><li><code>再配置一个出站策略</code> ，北京网段去往苏州总部的流量策略</li></ul><p><img src="https://i.loli.net/2019/09/28/rDzJ1oie6X8xABY.png" alt="image.png"><br><img src="https://i.loli.net/2019/09/28/Erfyn4o8QhuUp9i.png" alt="image.png"></p><blockquote><ul><li>在安全选项中点击新增，参数要和对端保持一致</li></ul></blockquote><p><img src="https://i.loli.net/2019/09/28/enKlmjDcE1f6Yhq.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/09/28/9SdbnaE2xIhgm5C.png" alt="image.png"></p><p><code>到此配置结束。。。有问题请留言讨论</code></p>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
            <tag> 思科防火墙 </tag>
            
            <tag> VPN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Keepalived+Haproxy高可用怎么玩</title>
      <link href="/2019/09/21/haproxy/"/>
      <url>/2019/09/21/haproxy/</url>
      
        <content type="html"><![CDATA[<h3 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h3><h4 id="1-1-Haproxy功能特性"><a href="#1-1-Haproxy功能特性" class="headerlink" title="1.1 Haproxy功能特性"></a>1.1 Haproxy功能特性</h4><blockquote><ul><li>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。</li><li>HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</li></ul></blockquote><a id="more"></a><blockquote><ul><li>Haproxy四层负载。将网络流量负载平衡到多个服务器的最简单方法是使用第4层（传输层）负载平衡。以这种方式进行负载均衡将根据IP范围和端口转发用户流量。(常用作四层，这里就着重介绍四层负载均衡)</li></ul></blockquote><br><h4 id="1-2-准备工具"><a href="#1-2-准备工具" class="headerlink" title="1.2 准备工具"></a>1.2 准备工具</h4><blockquote><ul><li>keepalived（yum安装）</li><li>haproxy-1.9.8-0.el7.x86_64.rpm(官网下载rpm包)</li><li>两台Centos7服务器:192.168.10.1、192.168.10.2(两台主从高可用)</li><li>VIP虚拟IP: 172.16.20.20(keepalived高可用漂移)</li></ul></blockquote><p><img src="https://i.loli.net/2019/09/23/7rOYuLz1iXf9eJk.png" alt="haproxy01.png"></p><br><h3 id="二、Haproxy安装配置"><a href="#二、Haproxy安装配置" class="headerlink" title="二、Haproxy安装配置"></a>二、Haproxy安装配置</h3><h4 id="2-1-安装依赖"><a href="#2-1-安装依赖" class="headerlink" title="2.1 安装依赖"></a>2.1 安装依赖</h4><blockquote><ul><li>SSH登陆第一台服务器<code>192.168.10.1</code></li><li>新增www用户，用于启动haproxy服务</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh  192.168.10.1</span><br><span class="line">yum install gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel lua-devel GeoIP GeoIP-devel GeoIP-data  systemd-devel -y</span><br><span class="line">useradd www -s /sbin/nologin</span><br></pre></td></tr></table></figure><br><h4 id="2-2-安装haproxy"><a href="#2-2-安装haproxy" class="headerlink" title="2.2 安装haproxy"></a>2.2 安装haproxy</h4><blockquote><ul><li>拷贝<code>haproxy-1.9.8-0.el7.x86_64.rpm</code>到<code>/root/</code>目录下</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh  haproxy-1.9.8-0.el7.x86_64.rpm</span><br></pre></td></tr></table></figure><br><h4 id="2-3-配置haproxy-cfg"><a href="#2-3-配置haproxy-cfg" class="headerlink" title="2.3 配置haproxy.cfg"></a>2.3 配置haproxy.cfg</h4><blockquote><ul><li>进入主目录<code>/etc/haproxy/</code></li><li>vim haproxy.cfg</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    log 127.0.0.1 local0</span><br><span class="line">    log 127.0.0.1 local1 notice  //开启日志用的</span><br><span class="line">    user www</span><br><span class="line">    group www</span><br><span class="line">    maxconn 100000</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode tcp</span><br><span class="line">    retries 3</span><br><span class="line">    option tcplog</span><br><span class="line">    option redispatch</span><br><span class="line">    option abortonclose</span><br><span class="line">   #option dontlognull</span><br><span class="line">    option log-health-checks //开启后端server健康检查日志输出</span><br><span class="line">    option httpclose</span><br><span class="line">    balance roundrobin    //后端server流量轮询</span><br><span class="line">    maxconn 100000</span><br><span class="line">    timeout connect 3000</span><br><span class="line">    timeout client 3600000</span><br><span class="line">    timeout server 3600000</span><br><span class="line"></span><br><span class="line">listen status    //开启haproxy后台管理页面</span><br><span class="line">    bind :1080</span><br><span class="line">    mode http</span><br><span class="line">    log global</span><br><span class="line">    stats enable</span><br><span class="line">    stats refresh 30s</span><br><span class="line">    stats uri /admin  </span><br><span class="line">    stats realm HAProxy\ Stats</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats auth root:123456  //配置账户密码</span><br><span class="line">    stats admin if TRUE</span><br><span class="line"></span><br><span class="line">#####################</span><br><span class="line">配置两组四层服务案例</span><br><span class="line">#####################</span><br><span class="line">frontend MySQL  //定义这个服务的名字为MySQL</span><br><span class="line">    bind 172.16.20.20:3306  //监听VIP的3306端口</span><br><span class="line">    log global</span><br><span class="line"></span><br><span class="line">    acl ACL_DB-MYSQL-1   dst 172.16.20.20</span><br><span class="line">    use_backend DB-MYSQL-1  if ACL_DB-MYSQL-1 </span><br><span class="line">    </span><br><span class="line">frontend redis     //定义这个服务的名字为redis</span><br><span class="line">    bind 172.16.20.20:10333  //监听的VIP的10333端口</span><br><span class="line">    log global</span><br><span class="line">    default_backend redis</span><br><span class="line"></span><br><span class="line">backend DB-MYSQL-1</span><br><span class="line">    log 127.0.0.1 local0  notice //这行必须加上，否则日志不输出健康检查状态</span><br><span class="line">    server 192.168.100.20 192.168.100.21:3306 check inter 1000 rise 3 fall 3</span><br><span class="line">    server 192.168.100.21 192.168.100.21:3306 check inter 1000 rise 3 fall 3  backup //状态为备机，只要上面一个服务器挂了，健康检查3秒之后下线，然后备机就顶上了</span><br><span class="line"></span><br><span class="line">backend  redis</span><br><span class="line">   log 127.0.0.1 local0  notice</span><br><span class="line">   server 192.168.100.22 192.168.100.22:6379 check inter 1000 rise 3 fall 3</span><br></pre></td></tr></table></figure><br><h4 id="2-4-启动服务"><a href="#2-4-启动服务" class="headerlink" title="2.4 启动服务"></a>2.4 启动服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#验证配置有没有语法错误</span><br><span class="line">/etc/haproxy/sbin/haproxy  -c -f  /etc/haproxy/haproxy.cfg</span><br><span class="line">Configuration file is valid //出现这个表示配置文件没问题</span><br><span class="line">systemctl start  haproxy  //启动</span><br><span class="line">systemctl reload haproxy  //重新载入配置</span><br></pre></td></tr></table></figure><br><h3 id="三、Keepalived安装配置"><a href="#三、Keepalived安装配置" class="headerlink" title="三、Keepalived安装配置"></a>三、Keepalived安装配置</h3><h4 id="3-1-yum安装"><a href="#3-1-yum安装" class="headerlink" title="3.1 yum安装"></a>3.1 yum安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived  -y</span><br></pre></td></tr></table></figure><br><h4 id="3-2-keepalived配置文件"><a href="#3-2-keepalived配置文件" class="headerlink" title="3.2 keepalived配置文件"></a>3.2 keepalived配置文件</h4><blockquote><ul><li>keepalived 采用的是非抢占模式（建议）</li><li>vim   /etc/keepalived/keepalived.conf</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">&#125;</span><br><span class="line">#这是第一个脚本，检测haproxy进程是否存在，不存在则结束keepalived,VIP漂移到备用从服务器，实现高可用</span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_haproxy.sh&quot;  //脚本存放路径</span><br><span class="line">     &#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP  //都定义backup为非抢占模式</span><br><span class="line">    nopreempt</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 100</span><br><span class="line">    priority 100  //主机器权重为100，从机器要比这小，可以配置90</span><br><span class="line">    advert_int 1</span><br><span class="line">    unicast_src_ip 192.168.10.1  //本机主IP</span><br><span class="line"></span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        192.168.10.2  //对端从IP,在从机器上，这两个主从IP是反过来的</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass haproxy //这里可以自定义一个字符串，但两边要保证一致</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">         172.16.20.20/16  //虚拟IP配置在这里</span><br><span class="line">     &#125;</span><br><span class="line">     #以下是另外一个脚本，在日志里面打印出keepalived服务状态，</span><br><span class="line">    notify_master &quot;/etc/keepalived/notify_action.sh MASTER&quot;  </span><br><span class="line">    notify_backup &quot;/etc/keepalived/notify_action.sh BACKUP&quot;</span><br><span class="line">    notify_fault &quot;/etc/keepalived/notify_action.sh FAULT&quot;</span><br><span class="line">    notify_stop &quot;/etc/keepalived/notify_action.sh STOP&quot;</span><br><span class="line">    garp_master_delay 1</span><br><span class="line">    garp_master_refresh 5</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy  //调用上面定义的脚本</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h4 id="3-3-自定义脚本"><a href="#3-3-自定义脚本" class="headerlink" title="3.3 自定义脚本"></a>3.3 自定义脚本</h4><h5 id="3-3-1-haproxy状态检测脚本"><a href="#3-3-1-haproxy状态检测脚本" class="headerlink" title="3.3.1 haproxy状态检测脚本"></a>3.3.1 haproxy状态检测脚本</h5><blockquote><ul><li>此脚本的目的是检测haproxy状态，当haproxy主程序挂掉之后，自动杀掉keepalived程序，把vip漂移到备用从服务器，从而实现高可用</li><li>vim  /etc/keepalived/check_haproxy.sh</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#检测nginx进程不存在了，尝试启动，发现启动不了则切换到备用机器</span><br><span class="line">A=`ps -C haproxy --no-header |wc -l`</span><br><span class="line">if [ `ps -C haproxy --no-header |wc -l` -eq 0 ];then</span><br><span class="line">        systemctl stop  keepalived</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><br><h5 id="3-3-2-Keepalived日志输出状态"><a href="#3-3-2-Keepalived日志输出状态" class="headerlink" title="3.3.2 Keepalived日志输出状态"></a>3.3.2 Keepalived日志输出状态</h5><blockquote><ul><li>这个脚本可选，属于我自己自定义的，没有需要可以跳过，并去掉keepalived配置文件里的引用此脚本部分</li><li>此脚本目的就是当keepalived状态发生改变，比如服务停止、启动把定义的状态输出到日志上，以便后续排错</li><li>vim /etc/keepalived/notify_action.sh</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#/etc/keepalived/notify_action.sh</span><br><span class="line">log_file=/var/log/keepalived.log</span><br><span class="line">log_write()</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;[`date &apos;+%Y-%m-%d %T&apos;`] $1&quot; &gt;&gt; $log_file</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[ ! -d /var/keepalived/ ] &amp;&amp; mkdir -p /var/keepalived/</span><br><span class="line"></span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">    &quot;MASTER&quot; )</span><br><span class="line">        echo -n &quot;$1&quot; &gt; /var/keepalived/state</span><br><span class="line">        log_write &quot; notify_master&quot;</span><br><span class="line">        echo -n &quot;0&quot; &gt; /var/keepalived/vip_check_failed_count</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    &quot;BACKUP&quot; )</span><br><span class="line">        echo -n &quot;$1&quot; &gt; /var/keepalived/state</span><br><span class="line">        log_write &quot; notify_backup&quot;</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    &quot;FAULT&quot; )</span><br><span class="line">        echo -n &quot;$1&quot; &gt; /var/keepalived/state</span><br><span class="line">        log_write &quot; notify_fault&quot;</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    &quot;STOP&quot; )</span><br><span class="line">        echo -n &quot;$1&quot; &gt; /var/keepalived/state</span><br><span class="line">        log_write &quot; notify_stop&quot;</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        log_write &quot;notify_action.sh: STATE ERROR!!!&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><br><h5 id="3-3-3-脚本添加权限"><a href="#3-3-3-脚本添加权限" class="headerlink" title="3.3.3 脚本添加权限"></a>3.3.3 脚本添加权限</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x check_haproxy.sh  notify_action.sh</span><br></pre></td></tr></table></figure><br><h4 id="3-4-启动keepalived服务"><a href="#3-4-启动keepalived服务" class="headerlink" title="3.4 启动keepalived服务"></a>3.4 启动keepalived服务</h4><blockquote><ul><li>启动服务后，可以通过<code>ip a</code>查看本机ip是否多了一个虚拟ip：172.16.20.20 绑定在上面，这样就算成功了</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived   //启动</span><br><span class="line">systemctl reload keepalived  //变更配置后，一般用这个命令重新加载</span><br></pre></td></tr></table></figure><br><h4 id="3-4-备用从服务器操作注意事项"><a href="#3-4-备用从服务器操作注意事项" class="headerlink" title="3.4 备用从服务器操作注意事项"></a>3.4 备用从服务器操作注意事项</h4><blockquote><ul><li>把上面haproxy安装配置和keepalived安装配置照着完全做一份，操作步骤一样，可以安装好把主服务器上配置文件拷贝过去</li><li>唯一的区别就是从服务器的keepalived配置文件有稍微区别需要注意,我直接附上配置</li><li>vim   /etc/keepalived/keepalived.conf</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">&#125;</span><br><span class="line">#这是第一个脚本，检测haproxy进程是否存在，不存在则结束keepalived,VIP漂移到备用从服务器，实现高可用</span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_haproxy.sh&quot;  //脚本存放路径</span><br><span class="line">     &#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP  //都定义backup为非抢占模式</span><br><span class="line">    nopreempt</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 100  //此ID号保持一致，同一个局域网最好不要有重复的</span><br><span class="line">    priority 90  //主机器权重为100，这里设置90，一定要比主的小</span><br><span class="line">    advert_int 1</span><br><span class="line">    unicast_src_ip 192.168.10.2  //本机主IP</span><br><span class="line"></span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        192.168.10.1  //对端从IP</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass haproxy //这里可以自定义一个字符串，但两边要保证一致</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">         172.16.20.20/16  //虚拟IP配置在这里</span><br><span class="line">     &#125;</span><br><span class="line">     #以下是另外一个脚本，在日志里面打印出keepalived服务状态，</span><br><span class="line">    notify_master &quot;/etc/keepalived/notify_action.sh MASTER&quot;  </span><br><span class="line">    notify_backup &quot;/etc/keepalived/notify_action.sh BACKUP&quot;</span><br><span class="line">    notify_fault &quot;/etc/keepalived/notify_action.sh FAULT&quot;</span><br><span class="line">    notify_stop &quot;/etc/keepalived/notify_action.sh STOP&quot;</span><br><span class="line">    garp_master_delay 1</span><br><span class="line">    garp_master_refresh 5</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy  //调用上面定义的脚本</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h4 id="3-5-验证配置"><a href="#3-5-验证配置" class="headerlink" title="3.5 验证配置"></a>3.5 验证配置</h4><blockquote><ul><li>杀掉主服务器上的haproxy程序，看看keepalived是否也紧跟着同时被杀掉了，虚ip被漂移到备用服务器上了</li><li>连接虚拟ip的6379端口以及3306端口，看能否正常转发到后端服务器上</li><li>访问haproxy管理页面：<a href="http://172.16.20.20:1080/admin" target="_blank" rel="noopener">http://172.16.20.20:1080/admin</a> (root/123456)</li></ul></blockquote><br><h3 id="四、日志开启及切割"><a href="#四、日志开启及切割" class="headerlink" title="四、日志开启及切割"></a>四、日志开启及切割</h3><blockquote><ul><li>keepalivedi日志开启，存储到 <code>/var/log/keepalived.log</code></li><li>haproxy开启日志，存储到<code>/var/log/haproxy/haproxy.log</code></li><li>每日0点切割日志压缩保存</li></ul></blockquote><br><h4 id="4-1-开启keepalived日志"><a href="#4-1-开启keepalived日志" class="headerlink" title="4.1 开启keepalived日志"></a>4.1 开启keepalived日志</h4><blockquote><ul><li>vim /etc/sysconfig/keepalived</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KEEPALIVED_OPTIONS=&quot;-D -S 0 -d&quot;</span><br></pre></td></tr></table></figure><blockquote><ul><li>vim /etc/rsyslog.conf </li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local0.*  /var/log/keepalived.log</span><br></pre></td></tr></table></figure><blockquote><ul><li>service rsyslog restart </li></ul></blockquote><br><h4 id="4-1-开启Haproxy日志"><a href="#4-1-开启Haproxy日志" class="headerlink" title="4.1 开启Haproxy日志"></a>4.1 开启Haproxy日志</h4><blockquote><ul><li>vim /etc/rsyslog.conf</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyslog.conf</span><br><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514</span><br><span class="line">local0.*     /var/log/haproxy/haproxy.log</span><br></pre></td></tr></table></figure><blockquote><ul><li>vim /etc/rsyslog.conf </li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local0.*  /var/log/keepalived.log</span><br></pre></td></tr></table></figure><blockquote><ul><li>service rsyslog restart </li></ul></blockquote><br><h4 id="4-3-切割Haproxy日志"><a href="#4-3-切割Haproxy日志" class="headerlink" title="4.3 切割Haproxy日志"></a>4.3 切割Haproxy日志</h4><blockquote><ul><li>如果不设定时间，切割默认是凌晨3点多执行</li><li>vim /etc/logrotate.d/logrotate_haproxy</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/var/log/haproxy/haproxy.log &#123;</span><br><span class="line">        su root root</span><br><span class="line">        daily</span><br><span class="line">        missingok</span><br><span class="line">        rotate 15  //默认我设置的是保留15天</span><br><span class="line">        compress</span><br><span class="line">        notifempty</span><br><span class="line">        create 644 root root</span><br><span class="line">        dateext</span><br><span class="line">        sharedscripts</span><br><span class="line">        postrotate</span><br><span class="line">            systemctl restart rsyslog</span><br><span class="line">        endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ul><li>测试切割：<code>logrotate -d /etc/logrotate.d/logrotate_haproxy</code></li><li>强制执行切割：<code>/usr/sbin/logrotate  -f /etc/logrotate.d/logrotate_haproxy</code></li></ul></blockquote><br><h3 id="五、额外补充"><a href="#五、额外补充" class="headerlink" title="五、额外补充"></a>五、额外补充</h3><h4 id="5-1-Haproxy管理页面参数介绍"><a href="#5-1-Haproxy管理页面参数介绍" class="headerlink" title="5.1 Haproxy管理页面参数介绍"></a>5.1 Haproxy管理页面参数介绍</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">haproxy页面参数解释：</span><br><span class="line"></span><br><span class="line">页面详细参数解释</span><br><span class="line">Queue</span><br><span class="line">Cur: current queued requests //当前的队列请求数量</span><br><span class="line">Max：max queued requests     //最大的队列请求数量</span><br><span class="line">Limit：           //队列限制数量</span><br><span class="line">Session rate(每秒的连接回话)列表：</span><br><span class="line">scur: current sessions        //每秒的当前回话的限制数量</span><br><span class="line">smax: max sessions           //每秒的新的最大的回话量</span><br><span class="line">slim: sessions limit           //每秒的新回话的限制数量</span><br><span class="line"></span><br><span class="line">Sessions </span><br><span class="line">Total:            //总共回话量</span><br><span class="line"></span><br><span class="line">Cur:             //当前的回话</span><br><span class="line">Max: //最大回话 </span><br><span class="line">Limit: //回话限制</span><br><span class="line">Lbtot: total number of times a server was selected //选中一台服务器所用的总时间</span><br><span class="line">Bytes</span><br><span class="line">In： //网络的字节数输入总量  </span><br><span class="line">Out： //网络的字节数输出总量</span><br><span class="line"></span><br><span class="line">Denied</span><br><span class="line">Req: denied requests//拒绝请求量</span><br><span class="line"></span><br><span class="line">Resp：denied responses //拒绝回应</span><br><span class="line">Errors</span><br><span class="line">Req：request errors             //错误请求</span><br><span class="line">Conn：connection errors          //错误的连接</span><br><span class="line">Resp: response errors (among which srv_abrt)  ///错误的回应</span><br><span class="line"></span><br><span class="line">Warnings</span><br><span class="line">Retr: retries (warning)                      //重新尝试</span><br><span class="line">Redis：redispatches (warning)               //再次发送</span><br><span class="line">Server列表：</span><br><span class="line">Status:状态，包括up(后端机活动)和down(后端机挂掉)两种状态</span><br><span class="line">LastChk:    持续检查后端服务器的时间</span><br><span class="line">Wght: (weight) : 权重</span><br><span class="line">Act: server is active (server), number of active servers (backend) //活动链接数量</span><br><span class="line">Bck: server is backup (server), number of backup servers (backend) //backup：备份的服务器数量</span><br><span class="line">Down：          //后端服务器连接后都是down的数量</span><br><span class="line">Downtime: downtime: total downtime (in seconds)    //总的downtime 时间</span><br><span class="line">Throttle: warm up status                          //设备变热状态</span><br></pre></td></tr></table></figure><br><h4 id="5-2-Haproxy配置文件参数介绍"><a href="#5-2-Haproxy配置文件参数介绍" class="headerlink" title="5.2 Haproxy配置文件参数介绍"></a>5.2 Haproxy配置文件参数介绍</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">haproxy 配置中分成五部分内容，分别如下：</span><br><span class="line">global：  设置全局配置参数，属于进程的配置，通常是和操作系统相关。</span><br><span class="line">defaults：配置默认参数，这些参数可以被用到frontend，backend，Listen组件；</span><br><span class="line">frontend：接收请求的前端虚拟节点，Frontend可以更加规则直接指定具体使用后端的backend；</span><br><span class="line">backend：后端服务集群的配置，是真实服务器，一个Backend对应一个或者多个实体服务器；</span><br><span class="line">Listen ：frontend和backend的组合体。</span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「Resines」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https://blog.csdn.net/genglei1022/article/details/83374188</span><br><span class="line">global   # 全局参数的设置</span><br><span class="line">    log 127.0.0.1 local0 info</span><br><span class="line">    # log语法：log &lt;address_1&gt;[max_level_1] # 全局的日志配置，使用log关键字，指定使用127.0.0.1上的syslog服务中的local0日志设备，记录日志等级为info的日志</span><br><span class="line">    user haproxy</span><br><span class="line">    group haproxy</span><br><span class="line">    # 设置运行haproxy的用户和组，也可使用uid，gid关键字替代之</span><br><span class="line">    daemon</span><br><span class="line">    # 以守护进程的方式运行</span><br><span class="line">    nbproc 16</span><br><span class="line">    # 设置haproxy启动时的进程数，根据官方文档的解释，我将其理解为：该值的设置应该和服务器的CPU核心数一致，即常见的2颗8核心CPU的服务器，即共有16核心，则可以将其值设置为：&lt;=16 ，创建多个进程数，可以减少每个进程的任务队列，但是过多的进程数也可能会导致进程的崩溃。这里我设置为16</span><br><span class="line">    maxconn 4096</span><br><span class="line">    # 定义每个haproxy进程的最大连接数 ，由于每个连接包括一个客户端和一个服务器端，所以单个进程的TCP会话最大数目将是该值的两倍。</span><br><span class="line">    #ulimit -n 65536</span><br><span class="line">    # 设置最大打开的文件描述符数，在1.4的官方文档中提示，该值会自动计算，所以不建议进行设置</span><br><span class="line">    pidfile /var/run/haproxy.pid</span><br><span class="line">    # 定义haproxy的pid </span><br><span class="line">defaults # 默认部分的定义</span><br><span class="line">    mode http</span><br><span class="line">    # mode语法：mode &#123;http|tcp|health&#125; 。http是七层模式，tcp是四层模式，health是健康检测，返回OK</span><br><span class="line">    log 127.0.0.1 local3 err</span><br><span class="line">    # 使用127.0.0.1上的syslog服务的local3设备记录错误信息</span><br><span class="line">    retries 3</span><br><span class="line">    # 定义连接后端服务器的失败重连次数，连接失败次数超过此值后将会将对应后端服务器标记为不可用</span><br><span class="line">    option httplog</span><br><span class="line">    # 启用日志记录HTTP请求，默认haproxy日志记录是不记录HTTP请求的，只记录“时间[Jan 5 13:23:46] 日志服务器[127.0.0.1] 实例名已经pid[haproxy[25218]] 信息[Proxy http_80_in stopped.]”，日志格式很简单。</span><br><span class="line">    option redispatch</span><br><span class="line">    # 当使用了cookie时，haproxy将会将其请求的后端服务器的serverID插入到cookie中，以保证会话的SESSION持久性；而此时，如果后端的服务器宕掉了，但是客户端的cookie是不会刷新的，如果设置此参数，将会将客户的请求强制定向到另外一个后端server上，以保证服务的正常。</span><br><span class="line">    option abortonclose</span><br><span class="line">    # 当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接</span><br><span class="line">    option dontlognull</span><br><span class="line">    # 启用该项，日志中将不会记录空连接。所谓空连接就是在上游的负载均衡器或者监控系统为了探测该服务是否存活可用时，需要定期的连接或者获取某一固定的组件或页面，或者探测扫描端口是否在监听或开放等动作被称为空连接；官方文档中标注，如果该服务上游没有其他的负载均衡器的话，建议不要使用该参数，因为互联网上的恶意扫描或其他动作就不会被记录下来</span><br><span class="line">    option httpclose</span><br><span class="line">    # 这个参数我是这样理解的：使用该参数，每处理完一个request时，haproxy都会去检查http头中的Connection的值，如果该值不是close，haproxy将会将其删除，如果该值为空将会添加为：Connection: close。使每个客户端和服务器端在完成一次传输后都会主动关闭TCP连接。与该参数类似的另外一个参数是“option forceclose”，该参数的作用是强制关闭对外的服务通道，因为有的服务器端收到Connection: close时，也不会自动关闭TCP连接，如果客户端也不关闭，连接就会一直处于打开，直到超时。</span><br><span class="line">    contimeout 5000</span><br><span class="line">    # 设置成功连接到一台服务器的最长等待时间，默认单位是毫秒，新版本的haproxy使用timeout connect替代，该参数向后兼容</span><br><span class="line">    clitimeout 3000</span><br><span class="line">    # 设置连接客户端发送数据时的成功连接最长等待时间，默认单位是毫秒，新版本haproxy使用timeout client替代。该参数向后兼容</span><br><span class="line">    srvtimeout 3000</span><br><span class="line">    # 设置服务器端回应客户度数据发送的最长等待时间，默认单位是毫秒，新版本haproxy使用timeout server替代。该参数向后兼容</span><br><span class="line"> </span><br><span class="line">listen status # 定义一个名为status的部分</span><br><span class="line">    bind 0.0.0.0:1080</span><br><span class="line">    # 定义监听的套接字</span><br><span class="line">    mode http</span><br><span class="line">    # 定义为HTTP模式</span><br><span class="line">    log global</span><br><span class="line">    # 继承global中log的定义</span><br><span class="line">    stats refresh 30s</span><br><span class="line">    # stats是haproxy的一个统计页面的套接字，该参数设置统计页面的刷新间隔为30s</span><br><span class="line">    stats uri /admin?stats</span><br><span class="line">    # 设置统计页面的uri为/admin?stats</span><br><span class="line">    stats realm Private lands</span><br><span class="line">    # 设置统计页面认证时的提示内容</span><br><span class="line">    stats auth admin:password</span><br><span class="line">    # 设置统计页面认证的用户和密码，如果要设置多个，另起一行写入即可</span><br><span class="line">    stats hide-version</span><br><span class="line">    # 隐藏统计页面上的haproxy版本信息</span><br><span class="line"> </span><br><span class="line">frontend http_80_in # 定义一个名为http_80_in的前端部分</span><br><span class="line">    bind 0.0.0.0:80</span><br><span class="line">    # http_80_in定义前端部分监听的套接字</span><br><span class="line">    mode http</span><br><span class="line">    # 定义为HTTP模式</span><br><span class="line">    log global</span><br><span class="line">    # 继承global中log的定义</span><br><span class="line">    option forwardfor</span><br><span class="line">    # 启用X-Forwarded-For，在requests头部插入客户端IP发送给后端的server，使后端server获取到客户端的真实IP</span><br><span class="line">    acl static_down nbsrv(static_server) lt 1</span><br><span class="line">    # 定义一个名叫static_down的acl，当backend static_sever中存活机器数小于1时会被匹配到</span><br><span class="line">    acl php_web url_reg /*.php$</span><br><span class="line">    #acl php_web path_end .php</span><br><span class="line">    # 定义一个名叫php_web的acl，当请求的url末尾是以.php结尾的，将会被匹配到，上面两种写法任选其一</span><br><span class="line">    acl static_web url_reg /*.(css|jpg|png|jpeg|js|gif)$</span><br><span class="line">    #acl static_web path_end .gif .png .jpg .css .js .jpeg</span><br><span class="line">    # 定义一个名叫static_web的acl，当请求的url末尾是以.css、.jpg、.png、.jpeg、.js、.gif结尾的，将会被匹配到，上面两种写法任选其一</span><br><span class="line">    use_backend php_server if static_down</span><br><span class="line">    # 如果满足策略static_down时，就将请求交予backend php_server</span><br><span class="line">    use_backend php_server if php_web</span><br><span class="line">    # 如果满足策略php_web时，就将请求交予backend php_server</span><br><span class="line">    use_backend static_server if static_web</span><br><span class="line">    # 如果满足策略static_web时，就将请求交予backend static_server</span><br><span class="line"> </span><br><span class="line">backend php_server #定义一个名为php_server的后端部分</span><br><span class="line">    mode http</span><br><span class="line">    # 设置为http模式</span><br><span class="line">    balance source</span><br><span class="line">    # 设置haproxy的调度算法为源地址hash</span><br><span class="line">    cookie SERVERID</span><br><span class="line">    # 允许向cookie插入SERVERID，每台服务器的SERVERID可在下面使用cookie关键字定义</span><br><span class="line">    option httpchk GET /test/index.php</span><br><span class="line">    # 开启对后端服务器的健康检测，通过GET /test/index.php来判断后端服务器的健康情况</span><br><span class="line">    server php_server_1 10.12.25.68:80 cookie 1 check inter 2000 rise 3 fall 3 weight 2</span><br><span class="line">    server php_server_2 10.12.25.72:80 cookie 2 check inter 2000 rise 3 fall 3 weight 1</span><br><span class="line">    server php_server_bak 10.12.25.79:80 cookie 3 check inter 1500 rise 3 fall 3 backup</span><br><span class="line">    # server语法：server [:port] [param*] # 使用server关键字来设置后端服务器；为后端服务器所设置的内部名称[php_server_1]，该名称将会呈现在日志或警报中、后端服务器的IP地址，支持端口映射[10.12.25.68:80]、指定该服务器的SERVERID为1[cookie 1]、接受健康监测[check]、监测的间隔时长，单位毫秒[inter 2000]、监测正常多少次后被认为后端服务器是可用的[rise 3]、监测失败多少次后被认为后端服务器是不可用的[fall 3]、分发的权重[weight 2]、最后为备份用的后端服务器，当正常的服务器全部都宕机后，才会启用备份服务器[backup]</span><br><span class="line"> </span><br><span class="line">backend static_server</span><br><span class="line">    mode http</span><br><span class="line">    option httpchk GET /test/index.html</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 负载均衡 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 负载均衡 </tag>
            
            <tag> haproxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tengine安装</title>
      <link href="/2019/09/16/tenine-install/"/>
      <url>/2019/09/16/tenine-install/</url>
      
        <content type="html"><![CDATA[<h3 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h3><blockquote><ul><li>Tengine是由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。</li><li>我个人很欣赏的一个功能，它有一个很好的dyups模块，可以动态上下线upstream中的后端机器，而不用重启服务</li></ul></blockquote><h3 id="二、开始安装"><a href="#二、开始安装" class="headerlink" title="二、开始安装"></a>二、开始安装</h3><h4 id="2-1-安装依赖"><a href="#2-1-安装依赖" class="headerlink" title="2.1 安装依赖"></a>2.1 安装依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel lua-devel GeoIP GeoIP-devel GeoIP-data  systemd-devel -y</span><br></pre></td></tr></table></figure><a id="more"></a><br><h4 id="2-2-下载解压"><a href="#2-2-下载解压" class="headerlink" title="2.2 下载解压"></a>2.2 下载解压</h4><blockquote><ul><li>从官网 <code>http://tengine.taobao.org/</code>下载<code>tengine-2.2.3.tar.gz</code></li><li>解压到/root/目录下</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf  tengine-2.2.3.tar.gz</span><br></pre></td></tr></table></figure><h4 id="2-3-编译安装"><a href="#2-3-编译安装" class="headerlink" title="2.3 编译安装"></a>2.3 编译安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd tengine-2.2.3</span><br><span class="line">./configure --prefix=/usr/local/nginx --with-http_lua_module --with-http_dyups_module --with-http_dyups_lua_api --with-threads --with-http_v2_module --with-http_geoip_module --with-http_ssl_module --with-http_secure_link_module --add-module=/root/ngx_http_substitutions_filter_module --with-force-exit   --with-http_realip_module</span><br></pre></td></tr></table></figure><br><h4 id="2-4-服务启动"><a href="#2-4-服务启动" class="headerlink" title="2.4 服务启动"></a>2.4 服务启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/nginx/sbin/nginx /sbin/nginx</span><br><span class="line">nginx  -t</span><br><span class="line">nginx  -s reload</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 负载均衡 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tengine </tag>
            
            <tag> 负载均衡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tengine配置防百度爬虫</title>
      <link href="/2019/09/03/Anti-reptile/"/>
      <url>/2019/09/03/Anti-reptile/</url>
      
        <content type="html"><![CDATA[<blockquote><ul><li>发现此xxx.xxxx.cn一直被下面这个ua爬取:</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)</span><br></pre></td></tr></table></figure><blockquote><ul><li>tengine配置if判断ua，挡掉这个爬虫</li></ul></blockquote><a id="more"></a><br><h3 id="1-配置conf"><a href="#1-配置conf" class="headerlink" title="1.配置conf"></a>1.配置conf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim xxx.xxxx.cn </span><br><span class="line">#添加以下配置</span><br><span class="line"> if ($http_user_agent ~ &quot;Mozilla/5.0\ \(compatible;\ Baiduspider/2.0;\ \+http://www.baidu.com/search/spider.html&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">        return 403;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"> if ($http_user_agent ~* ^Baiduspider) </span><br><span class="line">        &#123;</span><br><span class="line">        return 403;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><br><h3 id="2-测试nginx-t-和-nginx-s-reload"><a href="#2-测试nginx-t-和-nginx-s-reload" class="headerlink" title="2.测试nginx  -t 和 nginx -s  reload"></a>2.测试<code>nginx  -t</code> 和 <code>nginx -s  reload</code></h3><br><h3 id="3-额外补充方法："><a href="#3-额外补充方法：" class="headerlink" title="3.额外补充方法："></a>3.额外补充方法：</h3><h4 id="3-1-新建user-agent-deny-conf配置文件"><a href="#3-1-新建user-agent-deny-conf配置文件" class="headerlink" title="3.1 新建user-agent_deny.conf配置文件"></a>3.1 新建<code>user-agent_deny.conf</code>配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#禁止Scrapy等工具的抓取</span><br><span class="line">if ($http_user_agent ~* (Scrapy|Curl|HttpClient)) &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#禁止指定UA及UA为空的访问</span><br><span class="line">if ($http_user_agent ~* &quot;FeedDemon|Indy Library|YandexBot|Alexa Toolbar|AskTbFXTV|AhrefsBot|CrawlDaddy|CoolpadWebkit|Java|Feedly|UniversalFeedParser|ApacheBench|Microsoft URL Control|Swiftbot|ZmEu|oBot|jaunty|Python-urllib|lightDeckReports Bot|YYSpider|DigExt|HttpClient|MJ12bot|heritrix|EasouSpider|Ezooms|^$&quot; ) &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#禁止非GET|HEAD|POST方式的抓取</span><br><span class="line">if ($request_method !~ ^(GET|HEAD|POST)$) &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line">#然后直接reload即可</span><br></pre></td></tr></table></figure><br><h4 id="3-2-添加default-server"><a href="#3-2-添加default-server" class="headerlink" title="3.2 添加default_server;"></a>3.2 添加default_server;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">           listen       81  default_server;</span><br><span class="line">           server_name  _;</span><br><span class="line">           return       403;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><blockquote><ul><li>default_server：nginx的虚拟主机是通过HTTP请求中的Host值来找到对应的虚拟主机配置</li><li>对于未绑定的域名指向你的服务器时，匹配不到你配置的虚拟主机域名后，会默认使用这个虚拟主机，然后直接返回403（状态码，可以自己定义，且返回内容可以通过error_page、echo或是lua等等）</li></ul></blockquote><br><h4 id="3-3-封阻UA"><a href="#3-3-封阻UA" class="headerlink" title="3.3 封阻UA"></a>3.3 封阻UA</h4><ul><li>碰到爬虫，取出UA,比如：</li></ul><p>Mozilla/5.0 (Linux; Android 8.0; Pixel 2 Build/OPD3.170816.012) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.3056.1748 Mobile Safari/537.36; Bytespider</p><ul><li>nginx配置匹配格式：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~* Bytespider) &#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>]]></content>
      
      
      <categories>
          
          <category> 负载均衡 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tengine </tag>
            
            <tag> 负载均衡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cisco switch配置管理</title>
      <link href="/2019/07/25/cisco-switch/"/>
      <url>/2019/07/25/cisco-switch/</url>
      
        <content type="html"><![CDATA[<h3 id="一、准备"><a href="#一、准备" class="headerlink" title="一、准备"></a>一、准备</h3><h4 id="1-1-准备工具"><a href="#1-1-准备工具" class="headerlink" title="1.1 准备工具"></a>1.1 准备工具</h4><blockquote><p><code>当拿到一台新的思科交换机，开始动手配置，目标实现远程登陆和管理</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">硬件：笔记本、Console配置线、交换机Cisco3560一台</span><br><span class="line">软件：SecureCRT</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/22/HZSdXCcyQT4s3lb.png" alt="12.png"></p><a id="more"></a><br><h4 id="1-2-连接交换机"><a href="#1-2-连接交换机" class="headerlink" title="1.2 连接交换机"></a>1.2 连接交换机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">首先在“计算机”----“管理”----“设备管理器”中查看com口的编号(本例为com3口)</span><br><span class="line">然后打开SecureCRT软件，添加连接：</span><br><span class="line">协议：Serial</span><br><span class="line">端口：com3</span><br><span class="line">波特率：9600</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/09/22/k2jXoFs9lBCYMPD.png" alt="13.png"><br><img src="https://i.loli.net/2019/09/22/kxTBHgDIaGywWAu.png" alt="14.png"></p><p><code>成功连接之后开始进行配置</code>    </p><br><h3 id="二、交换机配置管理"><a href="#二、交换机配置管理" class="headerlink" title="二、交换机配置管理"></a>二、交换机配置管理</h3><h4 id="2-1、配置登录用户、密码及SSH连接"><a href="#2-1、配置登录用户、密码及SSH连接" class="headerlink" title="2.1、配置登录用户、密码及SSH连接"></a>2.1、配置登录用户、密码及SSH连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Switch#configure terminal       //进入配置模式</span><br><span class="line">Switch(config)# ip domain-name loverbook.com //在生成加密密码时需要用到用户名和域名</span><br><span class="line">Switch(config)#crypto key generate rsa   //生成加密密钥</span><br><span class="line">The name for the keys will be: Switch.loverbook.com</span><br><span class="line">Choose the size of the key modulus in the range of 360 to 2048 for your General Purpose Keys. Choosing a key modulus greater than 512 may takea few minutes.</span><br><span class="line">How many bits in the modulus [512]: 1024   //生成一个rsa算法的密钥，密钥为1024位</span><br><span class="line">% Generating 1024 bit RSA keys, keys will be non-exportable...[OK]</span><br><span class="line">Switch(config)#line vty 0 15   //进入vty模式</span><br><span class="line">Switch(config-line)#transport input none  //取消任何登录方式</span><br><span class="line">Switch(config-line)#transport input ssh  //只允许ssh登录</span><br><span class="line">Switch(config-line)#exit  //退出vty</span><br><span class="line">Switch(config)#aaa new-mode   //开启AAA认证</span><br><span class="line">Switch(config)#aaa authentication login default local  //本地认证</span><br><span class="line">Switch(config)# username admin privilege 15 password admin //创建一个用户和密码</span><br><span class="line">Switch(config)#ip ssh version 2 //启用ssh版本号</span><br><span class="line">Switch#sh ip ssh   //查看自己配置的ssh</span><br><span class="line">SSH Enabled - version 2.0</span><br><span class="line">Authentication timeout: 120 secs; Authentication retries: 3</span><br></pre></td></tr></table></figure><br><h4 id="2-2-为交换机配置远程管理IP地址："><a href="#2-2-为交换机配置远程管理IP地址：" class="headerlink" title="2.2 为交换机配置远程管理IP地址："></a>2.2 为交换机配置远程管理IP地址：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BOOK#conf  t</span><br><span class="line">BOOK(config)#int vlan 1  //进入默认vlan 1（把交换机第一口划到vlan1中，连接上层设备）</span><br><span class="line">BOOK(config-if)#ip address 192.168.1.1  255.255.255.0  //配置管理地址，即可在客户端用新建的用户及密码SSH登录</span><br></pre></td></tr></table></figure><br><h4 id="2-3-配置交换机名字及enable用户模式密码"><a href="#2-3-配置交换机名字及enable用户模式密码" class="headerlink" title="2.3 配置交换机名字及enable用户模式密码"></a>2.3 配置交换机名字及enable用户模式密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Switch#configure terminal  </span><br><span class="line">Switch(config)#hostname  BOOK     //配置交换机名称</span><br><span class="line">BOOK(config)#enable secret BOOK    //配置用户模式密码</span><br><span class="line">Switch(config)#service password-encryption   //对所有设置的密码进行加密，可以不配置</span><br></pre></td></tr></table></figure><br><h4 id="2-4-端口及vlan的配置管理"><a href="#2-4-端口及vlan的配置管理" class="headerlink" title="2.4 端口及vlan的配置管理"></a>2.4 端口及vlan的配置管理</h4><blockquote><ul><li>常用<code>show int status</code>查看端口状态:<code>connected、disable、notconnect</code>三种状态</li><li>创建和删除vlan （以实际办公网段为准）</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BOOK#conf  t        </span><br><span class="line">BOOK(config)#vlan 12    //创建12网段</span><br><span class="line">BOOK(config-vlan)#no shutdown  //默认创建好就是开启的，这步可以省略</span><br><span class="line">BOOK(config)# no  vlan  12   //删除12网段</span><br></pre></td></tr></table></figure><blockquote><ul><li>端口配置</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BOOK#conf  t</span><br><span class="line">BOOK(config)#int fa0/2   //进入端口2</span><br><span class="line">BOOK(config-if)#switchport mode access  //把端口设置为access普通端口</span><br><span class="line">BOOK(config-if)#shutdown    //端口关闭</span><br><span class="line">BOOK(config-if)#no shutdown  //端口打开</span><br><span class="line">BOOK(config-if)#switchport  access  vlan  12 //把2端口加入12网段</span><br></pre></td></tr></table></figure><br><h4 id="2-5-开启三层路由及静态路由配置"><a href="#2-5-开启三层路由及静态路由配置" class="headerlink" title="2.5. 开启三层路由及静态路由配置"></a>2.5. 开启三层路由及静态路由配置</h4><blockquote><ul><li>防火墙内网口地址：<code>192.168.1.2</code>  &amp;  交换机默认vlan1管理地址：<code>192.168.1.1</code></li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BOOK#conf t</span><br><span class="line">BOOK(config)#ip routing   //开启三层路由，开启后所有网段互通</span><br><span class="line">BOOK(config)#no ip routing  //关闭三层路由</span><br><span class="line">BOOK(config)#ip  route 0.0.0.0 0.0.0.0  192.168.1.2  //指向上一层防火墙内网口地址</span><br><span class="line">备注：然后新加的12网段，需要在防火墙上添加一个返程路由即可</span><br><span class="line">Cisco防火墙配置路由</span><br><span class="line">BOOK-office#  conf t</span><br><span class="line">BOOK-office(config)# route inside 192.168.12.0 255.255.255.0  192.168.1.1</span><br></pre></td></tr></table></figure><br><h3 id="三、实战演练"><a href="#三、实战演练" class="headerlink" title="三、实战演练"></a>三、实战演练</h3><h4 id="3-1-新增部署网段的步骤"><a href="#3-1-新增部署网段的步骤" class="headerlink" title="3.1 新增部署网段的步骤"></a>3.1 新增部署网段的步骤</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">BOOK#conf t</span><br><span class="line">BOOK(config)#vlan 13 //创建vlan 13</span><br><span class="line">BOOK(config-vlan)#exit  //退出到配置模式</span><br><span class="line">BOOK(config)#int vlan 13  // 进入vlan 13</span><br><span class="line">BOOK(config-if)#ip address 192.168.13.1  255.255.255.0 //配置99网段的网关地址</span><br><span class="line">BOOK(config-if)#description bangong-vlan13  //可以对vlan13进行描述，方便后期管理</span><br><span class="line">BOOK(config-if)#exit  //退出到配置模式</span><br><span class="line">BOOK(config)#ip dhcp pool 13  //创建99网段的地址池</span><br><span class="line">BOOK(dhcp-config)# network 192.168.13.0  255.255.255.0  //配置网段</span><br><span class="line">BOOK(dhcp-config)# default-router 192.168.13.1  //指定网段的网关</span><br><span class="line">BOOK(dhcp-config)# dns-server 8.8.8.8  202.96.209.5  //配置网段的主和辅DNS</span><br><span class="line">BOOK(dhcp-config)# lease  2  //IP地址的租约时间为2天，超过两天没用就会释放</span><br><span class="line">BOOK(config-if)#exit  //退出到配置模式</span><br><span class="line">BOOK(config)#ip dhcp excluded-address 192.168.13.1 192.168.13.20 //排除掉的IP地址不分配</span><br><span class="line">BOOK(config)#int  range  fa0/2 -24 //对2到24端口全局配置</span><br><span class="line">BOOK(config-if-range)#switchport access vlan 13 //全部加入到13网段</span><br></pre></td></tr></table></figure><br><h4 id="3-2-IP和MAC地址绑定"><a href="#3-2-IP和MAC地址绑定" class="headerlink" title="3.2 IP和MAC地址绑定"></a>3.2 IP和MAC地址绑定</h4><blockquote><ul><li>需求：张三想把IP地址192.168.12.80和507b.9dbe.55ea绑定，让客户端只有连接上网络，就会分配这个IP地址，如果更改其它IP则无法上网</li><li>思路：首先 12网段的地址池已经有了，客户端如果想获取特定的ip地址，必须先把这个地址从12网段里排除掉，让这个地址不会分配，然后建立一个自己的99网段地址池</li><li>步骤如下：</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOK(config)#ip dhcp excluded-address 192.168.12.80  //先把这个IP地址排除不分配</span><br><span class="line">BOOK(config)#ip dhcp pool 12_zhangsan  //建立一个张三自己的地址池，名字不能和已有的pool_12重复</span><br><span class="line">BOOK(dhcp-config)# host 192.168.12.80  255.255.255.0 //指定张三的ip地址</span><br><span class="line">BOOK(dhcp-config)# client-identifier 0150.7b9d.be55.ea // MAC地址格式为01xx.xxxx.xxxx.xx</span><br><span class="line">BOOK(dhcp-config)# dns-server 8.8.8.8 202.96.209.5 //指定DNS</span><br><span class="line">BOOK(dhcp-config)# default-router 192.168.12.1 // 指定网关</span><br><span class="line">BOOK(config)#arp 192.168.12.80   7b.9dbe.55ea  ARPA //绑定生效</span><br></pre></td></tr></table></figure><br><h4 id="3-3-网段访问控制列表"><a href="#3-3-网段访问控制列表" class="headerlink" title="3.3 网段访问控制列表"></a>3.3 网段访问控制列表</h4><blockquote><ul><li>需求：要求办公12网段和财务网段33隔离开，只允许特定的主机可以访问33网段，其它拒绝掉</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BOOK# conf t</span><br><span class="line">BOOK(config)#ip access-list extended 100  //做一个访问控制列表，编号100</span><br><span class="line">BOOK(config-ext-nacl)#permit ip host 192.168.12.80 any //允许张三这台机器可以访问任何网段</span><br><span class="line">BOOK(config-ext-nacl)#permit ip host 192.168.12.80 host 192.168.33.8 //允许张三访问88.8主机</span><br><span class="line">BOOK(config-ext-nacl)#deny  ip any 192.168.22.0 0.0.0.255  //拒绝12网段访问33网段</span><br><span class="line">BOOK(config-ext-nacl)#permit ip any any //允许所有，这条必须加上，否则未放行的无法上网            </span><br><span class="line">BOOK(config-ext-nacl)#exit  //退出到配置模式</span><br><span class="line">BOOK(config)#int vlan 12  //进入12网段下</span><br><span class="line">BOOK(config-if)#ip  access-group  100  in  //应用访问控制列表</span><br></pre></td></tr></table></figure><br><h4 id="3-4-常用基本维护命令"><a href="#3-4-常用基本维护命令" class="headerlink" title="3.4 常用基本维护命令"></a>3.4 常用基本维护命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Show int status  查看端口状态</span><br><span class="line">Show  run     查看配置</span><br><span class="line">Show  ip  dhcp  pool  查看全部地址池的使用情况</span><br><span class="line">Show  ip  dhcp  pool  vlan 12  只查看12网段的地址池</span><br><span class="line">Show  ip  dhcp  binding      查看租约信息</span><br><span class="line">Show  ip  dhcp  conflict      查看地址冲突信息</span><br><span class="line">Show  ip  dhcp  server  statistics    查看DHCP收发数据包统计表</span><br><span class="line">Show  ip  arp  192.168.12.xx   根据ip地址追踪mac地址</span><br><span class="line">Show mac address-table address  7b.9dbe.55ea根据mac追踪具体端口位置</span><br><span class="line">如果出现网络地址受限，获取不到IP地址，看看是不是地址池满了，重新释放刷新地址池</span><br><span class="line">清除命令：</span><br><span class="line">Clear ip dhcp server statist         清除收发数据统计信息</span><br><span class="line">clear ip dhcp binding  *             清除所有租约信息</span><br><span class="line">clear mac address-table dynamic      清除动态MAC地址列表</span><br><span class="line">clear arp-cache                    清除arp缓存</span><br></pre></td></tr></table></figure><br>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
            <tag> 思科交换机 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cisco asa防火墙配置管理</title>
      <link href="/2019/07/22/cisco-asa/"/>
      <url>/2019/07/22/cisco-asa/</url>
      
        <content type="html"><![CDATA[<h3 id="一、配置远程登录"><a href="#一、配置远程登录" class="headerlink" title="一、配置远程登录"></a>一、配置远程登录</h3><blockquote><ul><li>关于怎么用console线连接防火墙,可以参考我上一篇交换机配置博客：<a href="https://www.loverbook.cn/2019/07/25/cisco-switch/" target="_blank" rel="noopener">https://www.loverbook.cn/2019/07/25/cisco-switch/</a></li><li>Cisco asa 版本8.3之前的命令和之后区别很大，此篇博客以新版本命令为参考，版本太旧建议升级ios</li></ul></blockquote><h4 id="1-1-配置主机名及enable密码"><a href="#1-1-配置主机名及enable密码" class="headerlink" title="1.1 配置主机名及enable密码"></a>1.1 配置主机名及enable密码</h4><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ciscoasa(config)# hostname  BOOK-office</span><br><span class="line">BOOK-office(config)# enable password  xxxxxxx</span><br></pre></td></tr></table></figure><br><h4 id="1-2-配置远程SSH连接"><a href="#1-2-配置远程SSH连接" class="headerlink" title="1.2 配置远程SSH连接"></a>1.2 配置远程SSH连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BOOK-office(config)# crypto  key  generate  rsa  modulus  1024</span><br><span class="line">WARNING: You have a RSA keypair already defined named &lt;Default-RSA-Key&gt;.</span><br><span class="line">Do you really want to replace them? [yes/no]:  y //输入y回车</span><br><span class="line">BOOK-office(config)# write memory //保存配置</span><br><span class="line">BOOK-office(config)# ssh  0.0.0.0  0.0.0.0  inside //允许内网任何ip可以连接</span><br><span class="line">BOOK-office(config)#ssh  timeout  30 //设置超时时间,单位为分钟</span><br><span class="line">BOOK-office(config)# ssh  version 2</span><br><span class="line">BOOK-office(config)# username admin password xxxxx //配置远程登录账户</span><br><span class="line">-------------相关命令--------------</span><br><span class="line">show ssh                                  //参看SSH配置信息</span><br><span class="line">show crypto key mypubkey rsa    //查看产生的rsa密钥值</span><br><span class="line">crypto key zeroize                    //清空所有产生的密钥</span><br></pre></td></tr></table></figure><br><h3 id="二、接口配置"><a href="#二、接口配置" class="headerlink" title="二、接口配置"></a>二、接口配置</h3><h4 id="2-1-内外接口IP配置"><a href="#2-1-内外接口IP配置" class="headerlink" title="2.1 内外接口IP配置"></a>2.1 内外接口IP配置</h4><blockquote><ul><li>外接口 Gi0/0：100.100.100.100(自己公网IP)</li><li>内接口 Gi0/1:  192.168.1.1</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BOOK-office(config)# int gigabitEthernet 0/0   //把gi0/0配置成外接口</span><br><span class="line">BOOK-office(config-if)# no shutdown         //开启端口 </span><br><span class="line">BOOK-office(config-if)# security-level 0       </span><br><span class="line">BOOK-office(config-if)# nameif outside</span><br><span class="line">BOOK-office(config-if)# ip address 100.100.100.100 255.255.255.0 </span><br><span class="line">BOOK-office(config)# int gigabitEthernet 0/0   //把gi0/1配置成内接口</span><br><span class="line">BOOK-office(config-if)# no shutdown         //开启端口 </span><br><span class="line">BOOK-office(config-if)# security-level 100     //流量只允许高往低走      </span><br><span class="line">BOOK-office(config-if)# nameif inside</span><br><span class="line">BOOK-office(config-if)# ip address 192.168.1.1  255.255.255.0</span><br></pre></td></tr></table></figure><br><h3 id="三、防火墙内外流量打通"><a href="#三、防火墙内外流量打通" class="headerlink" title="三、防火墙内外流量打通"></a>三、防火墙内外流量打通</h3><h4 id="3-1-NAT转换"><a href="#3-1-NAT转换" class="headerlink" title="3.1 NAT转换"></a>3.1 NAT转换</h4><blockquote><p><code>把内部局域网网段转换流量出去进行上网</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BOOK-office(config)#object network inside  //定义一个地址对象inside 包含所有内网</span><br><span class="line">BOOK-office(config-network-object)# subnet 0.0.0.0  0.0.0.0 </span><br><span class="line">BOOK-office(config-network-object)# nat (inside,outside) dynamic interface  //Nat 转换</span><br></pre></td></tr></table></figure><br><h4 id="3-2-访问控制列表"><a href="#3-2-访问控制列表" class="headerlink" title="3.2 访问控制列表"></a>3.2 访问控制列表</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">----------定义一个 ip-mac的组，允许ip、imcp、tcp、udp协议通过---------</span><br><span class="line">BOOK-office(config)# access-list  ip-mac extended permit ip any any </span><br><span class="line">BOOK-office(config)# access-list  ip-mac extended permit imcp any any</span><br><span class="line">BOOK-office(config)# access-list  ip-mac extended permit tcp any any</span><br><span class="line">BOOK-office(config)# access-list  ip-mac extended permit udp any any</span><br><span class="line">BOOK-office(config)# access-group  ip-mac in interface inside //将这个组应用到内接口上</span><br></pre></td></tr></table></figure><br><h4 id="3-3-添加路由"><a href="#3-3-添加路由" class="headerlink" title="3.3 添加路由"></a>3.3 添加路由</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BOOK-office(config)# route outside 0.0.0.0 0.0.0.0 100.100.100.99 1  //出口路由指向出口IP网关</span><br><span class="line">BOOK-office(config)# route inside 192.168.2.0 255.255.255.0 192.168.1.2 1 //内部路由指向下一层连接交换机IP </span><br><span class="line">BOOK-office(config)# route inside 192.168.12.0 255.255.255.0 192.168.1.2 1 //新增网段2和网段12返程路由</span><br></pre></td></tr></table></figure><p><code>这样防火墙就可以实现内部局域网上网了，可以进行远程连接和上网测试了！！</code>                       </p><br><h3 id="四、NAT端口映射"><a href="#四、NAT端口映射" class="headerlink" title="四、NAT端口映射"></a>四、NAT端口映射</h3><h4 id="4-1-端口映射"><a href="#4-1-端口映射" class="headerlink" title="4.1 端口映射"></a>4.1 端口映射</h4><blockquote><ul><li>举例将内网一台测试服务器192.168.12.13的内网3389端口映射到外网的3389端口</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BOOK-office(config)#object network  testserver  //定义一个地址对象 testserver</span><br><span class="line">BOOK-office(config-network-object)# host 192.168.12.13</span><br><span class="line">BOOK-office(config-network-object)#nat (inside,outside) static interface service tcp 3389 3389</span><br></pre></td></tr></table></figure><br><h4 id="4-2-访问控制列表及策略应用"><a href="#4-2-访问控制列表及策略应用" class="headerlink" title="4.2 访问控制列表及策略应用"></a>4.2 访问控制列表及策略应用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-------定义控制列表100-------</span><br><span class="line">BOOK-office(config)#access-list 100 extended permit tcp any host 192.168.12.13 eq 3389</span><br><span class="line">-------将列表100应用到外接口上生效------</span><br><span class="line">BOOK-office(config)# access-group  100  in interface inside</span><br></pre></td></tr></table></figure><br><h3 id="五、宽带拨号（可选）"><a href="#五、宽带拨号（可选）" class="headerlink" title="五、宽带拨号（可选）"></a>五、宽带拨号（可选）</h3><h4 id="5-1-宽带PPOE拨号"><a href="#5-1-宽带PPOE拨号" class="headerlink" title="5.1 宽带PPOE拨号"></a>5.1 宽带PPOE拨号</h4><blockquote><ul><li>应用场景：没有固定IP地址，防火墙连接防火墙直接自身拨号，可以用此方法配置</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-------配置宽带账号和密码-------</span><br><span class="line">BOOK-office(config)# vpdn group ads1 request dialout pppoe</span><br><span class="line">BOOK-office(config)# vpdn group ads1 localname adxxxxx   //此处填写宽带账户</span><br><span class="line">BOOK-office(config)# vpdn group ads1 ppp authentication pap</span><br><span class="line">BOOK-office(config)# vpdn username adxxxxx password xxxxxxx  //宽带账户和密码</span><br><span class="line">-------把拨号方式应用到外接口上，替代之前的固定IP地址-------</span><br><span class="line">BOOK-office(config)# int gigabitEthernet 0/0</span><br><span class="line">BOOK-office(config-if)# pppoe client vpdn group ads1</span><br><span class="line">BOOK-office(config-if)# ip address pppoe setroute</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
            <tag> 思科防火墙 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Openvpn服务器搭建</title>
      <link href="/2019/05/20/Openvpnserver/"/>
      <url>/2019/05/20/Openvpnserver/</url>
      
        <content type="html"><![CDATA[<h3 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h3><blockquote><p>OpenVPN 是一个基于 OpenSSL 库的应用层 VPN 实现，和传统 VPN 相比，它的优点是简单易用、安全稳定。此次基于centos7.3系统编译安装，使用udp协议自定义端口，搭建的目的是为了能实现通过证书+账户密码双重认证的方法，登录到阿里云VPC内部，对服务器进行配置管理。</p></blockquote><a id="more"></a><br><blockquote><ul><li>准备工具</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Easy-rsa.zip  //秘钥制作工具</span><br><span class="line">Lzo-2.0.6.tar.gz  //依赖包</span><br><span class="line">Openvpn-2.3.3.tar.gz  //安装包</span><br></pre></td></tr></table></figure><blockquote><ul><li>网段</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openvpn主机ip : 172.xx.xx.xx</span><br><span class="line">外网ip: 100.100.100.100</span><br><span class="line">vpn网段：20.8.8.0</span><br></pre></td></tr></table></figure><br><h3 id="二、安装Openvpn"><a href="#二、安装Openvpn" class="headerlink" title="二、安装Openvpn"></a>二、安装Openvpn</h3><h4 id="2-1-安装依赖包"><a href="#2-1-安装依赖包" class="headerlink" title="2.1 安装依赖包"></a>2.1 安装依赖包</h4><blockquote><p><code>pam-devel是安装openvpn必要的依赖包</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# yum  -y  install  unzip ntpdate  pam-devel  openssl  openssl-devel</span><br></pre></td></tr></table></figure><br><h4 id="2-2-上传包文件"><a href="#2-2-上传包文件" class="headerlink" title="2.2 上传包文件"></a>2.2 上传包文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">通过ssh连接上openvpn服务器，把3个文件拷贝到/usr/local/目录下，并分别解压</span><br><span class="line">[root@test local]# unzip  easy-rsa.zip           #asy-rsa证书制作工具</span><br><span class="line">[root@test local]# tar  -zxvf   lzo-2.06.tar.gz    #lzo-2.0.6.tar.gz依赖包</span><br><span class="line">[root@test local]# tar  -zxvf   openvpn-2.3.3.tar.gz</span><br></pre></td></tr></table></figure><br><h4 id="2-3-创建安装目录"><a href="#2-3-创建安装目录" class="headerlink" title="2.3 创建安装目录"></a>2.3 创建安装目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@test local]# mkdir  -p  /usr/local/openvpn/conf   #于存放配置文件</span><br><span class="line">[root@test local]# mkdir  –p  /usr/local/openvpn/log    #于存放日志文件</span><br><span class="line">[root@test local]# mkdir  -p  /usr/local/openvpn/easy-rsa  #密钥生成工具及密钥</span><br></pre></td></tr></table></figure><br><h4 id="2-4-开始安装openvpn"><a href="#2-4-开始安装openvpn" class="headerlink" title="2.4 开始安装openvpn"></a>2.4 开始安装openvpn</h4><blockquote><p><code>进入/usr/local/目录下:</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@test local]# cd   lzo-2.06</span><br><span class="line">[root@test lzo-2.06]# ./configure --prefix=/usr   #装依赖库</span><br><span class="line">[root@test lzo-2.06]#make  &amp;&amp;  make  install</span><br><span class="line">[root@test lzo-2.06]#  /sbin/ldconfig         #置运行时动态链接库</span><br><span class="line">[root@test local]# cd  openvpn-2.3.3</span><br><span class="line">[root@test openvpn-2.3.3]# ./configure --prefix=/usr/local/openvpn/</span><br><span class="line">[root@test openvpn-2.3.3]# make  &amp;&amp;  make  install</span><br><span class="line">[root@testopenvpn-2.3.3]#cd  sample/sample-config-files/</span><br><span class="line">[root@test sample-config-files]# cp server.conf  /usr/local/openvpn/conf/ #贝配置文件</span><br><span class="line">[root@test local]# cd  easy-rsa/2.0/</span><br><span class="line">[root@test 2.0]# cp  -rf  *  /usr/local/openvpn/easy-rsa/</span><br><span class="line">[root@test 2.0]# cd  /usr/local/openvpn/easy-rsa/</span><br><span class="line">[root@test easy-rsa]# chmod  +x  *</span><br></pre></td></tr></table></figure><br><h3 id="三、配置openvpn"><a href="#三、配置openvpn" class="headerlink" title="三、配置openvpn"></a>三、配置openvpn</h3><h4 id="3-1-配置Vars文件及生成服务端证书"><a href="#3-1-配置Vars文件及生成服务端证书" class="headerlink" title="3.1 配置Vars文件及生成服务端证书"></a>3.1 配置Vars文件及生成服务端证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# cd  /usr/local/openvpn/easy-rsa/</span><br><span class="line">[root@test easy-rsa]# vim   vars    #配置vars文件（证书的默认配置）</span><br><span class="line">export KEY_SIZE=2048                   #加密位数，太大增加CPU负载</span><br><span class="line">export CA_EXPIRE=3650                  #证书有效期，这里是10年</span><br><span class="line">export KEY_EXPIRE=365                  #秘钥有效期</span><br><span class="line">export KEY_COUNTRY=&quot;CN&quot;              #国家</span><br><span class="line">export KEY_PROVINCE=&quot;SH&quot;              #省份</span><br><span class="line">export KEY_CITY=&quot;Shanghai&quot;             #所在城市</span><br><span class="line">export KEY_ORG=&quot;yunwei&quot;                # 组织单位</span><br><span class="line">export KEY_EMAIL=&quot;yunwei@book.cn&quot;    #邮箱地址</span><br><span class="line">export KEY_OU=&quot;Yunwei&quot;                #组织容器可以随便填写</span><br><span class="line">export KEY_NAME=&quot;VPNServer&quot;          #名称可以随便填写</span><br><span class="line">[root@test easy-rsa]# source  vars         #使配置生效</span><br><span class="line">下面开始制作根证书CA:</span><br><span class="line">[root@test easy-rsa]# ./clean-all           #初始化</span><br><span class="line">[root@test easy-rsa]# ./build-ca           #创建根证书，一路回车</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">..................................+++</span><br><span class="line">...............................+++</span><br><span class="line">writing new private key to &apos;ca.key&apos;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [CN]:  </span><br><span class="line">State or Province Name (full name) [SH]: </span><br><span class="line">Locality Name (eg, city) [Shanghai]: </span><br><span class="line">Organization Name (eg, company) [yunwei]: </span><br><span class="line">Organizational Unit Name (eg, section) [Yunwei]: </span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) [yunwei CA]: </span><br><span class="line">Name [EasyServer]: </span><br><span class="line">Email Address [yunwei@book.cn]: </span><br><span class="line">创建服务器端证书server和秘钥:</span><br><span class="line">[root@test easy-rsa]# ./build-key-server server   #一路回车默认，最后输入y确认</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">...........+++</span><br><span class="line">....+++</span><br><span class="line">writing new private key to &apos;server.key&apos;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [CN]:</span><br><span class="line">State or Province Name (full name) [SH]:</span><br><span class="line">Locality Name (eg, city) [Shanghai]:</span><br><span class="line">Organization Name (eg, company) [yunwei]:</span><br><span class="line">Organizational Unit Name (eg, section) [Yunwei]:</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) [server]:</span><br><span class="line">Name [EasyServer]:</span><br><span class="line">Email Address [yunwei@book.cn]:</span><br><span class="line"></span><br><span class="line">Please enter the following &apos;extra&apos; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line">Using configuration from /usr/local/openvpn/easy-rsa/openssl-1.0.0.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject&apos;s Distinguished Name is as follows</span><br><span class="line">countryName           :PRINTABLE:&apos;CN&apos;</span><br><span class="line">stateOrProvinceName   :PRINTABLE:&apos;SH&apos;</span><br><span class="line">localityName          :PRINTABLE:&apos;Shanghai&apos;</span><br><span class="line">organizationName      :PRINTABLE:&apos;yunwei&apos;</span><br><span class="line">organizationalUnitName:PRINTABLE:&apos;Yunwei&apos;</span><br><span class="line">commonName            :PRINTABLE:&apos;server&apos;</span><br><span class="line">name                  :PRINTABLE:&apos;EasyServer&apos;</span><br><span class="line">emailAddress          :IA5STRING:&apos;yunwei@book.cn&apos;</span><br><span class="line">Certificate is to be certified until Apr 15 15:35:32 2019 GMT (365 days)</span><br><span class="line">Sign the certificate? [y/n]:y         #输入y</span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n] y   #输入y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">[root@test easy-rsa]# ./build-dh  #创建dh2048加密协商文件</span><br><span class="line">[root@test easy-rsa]# </span><br><span class="line">[root@testeasy-rsa]#../sbin/openvpn  --genkey  --secret /usr/local/openvpn/easy-rsa/keys/ta.key   #生成防Dos攻击的文件</span><br></pre></td></tr></table></figure><br><h4 id="3-2-配置openvpn-server文件"><a href="#3-2-配置openvpn-server文件" class="headerlink" title="3.2 配置openvpn server文件"></a>3.2 配置openvpn server文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# vim  /usr/local/openvpn/conf/server.conf</span><br><span class="line">Local  172.xx.xx.xx    #本机监听地址</span><br><span class="line">port  2294           #自定义端口号</span><br><span class="line">proto udp            #使用udp协议</span><br><span class="line">dev tun              #tun是ip层的点对点协议,建议使用tun</span><br><span class="line">#证书若没放在conf下，需要指定路径</span><br><span class="line">ca  /usr/local/openvpn/easy-rsa/keys/ca.crt </span><br><span class="line">cert  /usr/local/openvpn/easy-rsa/keys/server.crt</span><br><span class="line">key /usr/local/openvpn/easy-rsa/keys/server.key  # This file should be kept secret</span><br><span class="line">dh  /usr/local/openvpn/easy-rsa/keys/dh2048.pem</span><br><span class="line">server  20.8.8.0 255.255.255.0    #服务器vpn网段地址</span><br><span class="line">#防止openvpn重新启动后“忘记”Client曾经使用过的IP地址</span><br><span class="line">ifconfig-pool-persist /usr/local/openvpn/log/ipp.txt </span><br><span class="line">#通过VPN Server往Client push路由，client通过pull指令获得 </span><br><span class="line">push &quot;route 20.8.8.0  255.255.255.0&quot;</span><br><span class="line">push &quot;route 172.xx.xx.0 255.255.255.0&quot;</span><br><span class="line">push &quot;dhcp-option DNS 223.5.5.5&quot;    #指定DNS地址</span><br><span class="line">push &quot;dhcp-option DNS 8.8.8.8&quot;</span><br><span class="line">client-to-client</span><br><span class="line">#和keys连接VPN，一定要打开这个选项，否则只允许一个人连接VPN</span><br><span class="line">duplicate-cn</span><br><span class="line">keepalive 10 120         </span><br><span class="line">comp-lzo          #对数据进行压缩</span><br><span class="line">max-clients 10      #支持客户端数</span><br><span class="line">通过keepalive检测超时后，重新启动VPN，不重新读取keys，保留第一次使用的keys</span><br><span class="line">persist-key</span><br><span class="line">#通过keepalive检测超时后，重新启动VPN，一直保持tun或者tap设备是linkup的，否则网络连接会先linkdown然后linkup</span><br><span class="line">persist-tun   </span><br><span class="line">status  /usr/local/openvpn/log/openvpn-status.log  #日志路径</span><br><span class="line">log-append  /usr/local/openvpn/log/openvpn.log</span><br><span class="line">verb 3</span><br></pre></td></tr></table></figure><br><h3 id="四、用户密码-证书验证配置"><a href="#四、用户密码-证书验证配置" class="headerlink" title="四、用户密码+证书验证配置"></a>四、用户密码+证书验证配置</h3><h4 id="4-1-创建客户端用户"><a href="#4-1-创建客户端用户" class="headerlink" title="4.1 创建客户端用户"></a>4.1 创建客户端用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# cd  /usr/local/openvpn/easy-rsa/</span><br><span class="line">[root@test easy-rsa]# ./build-key  book   #创建用户book，方法同server端</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">备注：执行后会在keys文件夹下，生成3个文件，book.crt、book.csr（mac电脑不需要这个文件）、book.key，另外加上同目录下的ca.crt、ca.key、ta.key和dh2048.pem这7个文件一起打包，即是客户端所需要的所有文件，添加其它用户也是同样的方法</span><br></pre></td></tr></table></figure><br><h4 id="4-2-配置账户密码验证"><a href="#4-2-配置账户密码验证" class="headerlink" title="4.2 配置账户密码验证"></a>4.2 配置账户密码验证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# vi /usr/local/openvpn/conf/server.conf  #配置文件中加上以下几行</span><br><span class="line">tls-auth  /usr/local/openvpn/easy-rsa/keys/ta.key 0  #server端是0 ,客户端为1</span><br><span class="line">auth-user-pass-verify   /usr/local/openvpn/easy-rsa/checkpsw.sh  via-env </span><br><span class="line">#密码验证的脚本文件放在此目录下，稍后创建脚本</span><br><span class="line">script-security 3</span><br><span class="line">username-as-common-name </span><br><span class="line">;client-cert-not-required  #如果只想账户密码验证，就开启这句</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">创建脚本文件：checkpsw.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">###########################################################</span><br><span class="line"># checkpsw.sh (C) 2004 Mathias Sundman &lt;mathias@openvpn.se&gt;</span><br><span class="line">#</span><br><span class="line"># This script will authenticate OpenVPN users against</span><br><span class="line"># a plain text file. The passfile should simply contain</span><br><span class="line"># one row per user with the username first followed by</span><br><span class="line"># one or more space(s) or tab(s) and then the password.</span><br><span class="line">PASSFILE=&quot;/usr/local/openvpn/easy-rsa/psw-file&quot; //指定保存账户和密码的文件</span><br><span class="line">LOG_FILE=&quot;/usr/local/openvpn/log/openvpn-password.log&quot;//保存日志文件</span><br><span class="line">TIME_STAMP=`date &quot;+%Y-%m-%d %T&quot;`</span><br><span class="line">###########################################################</span><br><span class="line">if [ ! -r &quot;$&#123;PASSFILE&#125;&quot; ]; then</span><br><span class="line">echo &quot;$&#123;TIME_STAMP&#125;: Could not open password file \&quot;$&#123;PASSFILE&#125;\&quot; for reading.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">exit 1</span><br><span class="line">fi</span><br><span class="line">CORRECT_PASSWORD=`awk &apos;!/^;/&amp;&amp;!/^#/&amp;&amp;$1==&quot;&apos;$&#123;username&#125;&apos;&quot;&#123;print $2;exit&#125;&apos; $&#123;PASSFILE&#125;`</span><br><span class="line">if [ &quot;$&#123;CORRECT_PASSWORD&#125;&quot; = &quot;&quot; ]; then</span><br><span class="line">echo &quot;$&#123;TIME_STAMP&#125;: User does not exist: username=\&quot;$&#123;username&#125;\&quot;, password=\&quot;$&#123;password&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">exit 1</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$&#123;password&#125;&quot; = &quot;$&#123;CORRECT_PASSWORD&#125;&quot; ]; then</span><br><span class="line">echo &quot;$&#123;TIME_STAMP&#125;: Successful authentication: username=\&quot;$&#123;username&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">exit 0</span><br><span class="line">fi</span><br><span class="line">echo &quot;$&#123;TIME_STAMP&#125;: Incorrect password: username=\&quot;$&#123;username&#125;\&quot;, password=\&quot;$&#123;password&#125;\&quot;.&quot; &gt;&gt; $&#123;LOG_FILE&#125;</span><br><span class="line">exit 1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">创建保存账户密码的文件： psw-file</span><br><span class="line">[root@test easy-rsa]#vi  psw-file</span><br><span class="line">book    123456  //账户+空格+密码格式保存</span><br></pre></td></tr></table></figure><br><h4 id="4-3-注销用户客户端"><a href="#4-3-注销用户客户端" class="headerlink" title="4.3  注销用户客户端"></a>4.3  注销用户客户端</h4><blockquote><p><code>如果同事离职了，需要注销证书</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@test easy-rsa]# ./revoke-full book   //注销用户book</span><br><span class="line">这个时候还是可以利用此证书登录服务器的，在server.conf下增加一行</span><br><span class="line">crl-verify  /usr/local/openvpn/easy-rsa/keys/crl.pem</span><br><span class="line">再重启下openvpn服务即可</span><br></pre></td></tr></table></figure><br><h4 id="4-4-启动openvpn"><a href="#4-4-启动openvpn" class="headerlink" title="4.4  启动openvpn"></a>4.4  启动openvpn</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@test~]# /usr/local/openvpn/sbin/openvpn   --config  /usr/local/openvpn/conf/server.conf   &amp;</span><br><span class="line">[root@test~]#ps –ef |grep openvpn</span><br><span class="line">root      1013     1  0 Apr13 ?   00:00:04 /usr/local/openvpn/sbin/openvpn --config /usr/local/openvpn/conf/server.conf  </span><br><span class="line">[root@test~]# netstat  -ntlup  //由此可见端口已在监听</span><br><span class="line">Udp 0 0 172.xx.xx.xx:2294    0.0.0.0:*        1013/openvpn</span><br></pre></td></tr></table></figure><br><h3 id="五、配置防火墙"><a href="#五、配置防火墙" class="headerlink" title="五、配置防火墙"></a>五、配置防火墙</h3><h4 id="5-1-开启路由转发"><a href="#5-1-开启路由转发" class="headerlink" title="5.1  开启路由转发"></a>5.1  开启路由转发</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward = 1  #将值改为1保存</span><br><span class="line">[root@test ~]# sysctl   -p  #执行生效</span><br></pre></td></tr></table></figure><br><h4 id="5-2-配置iptables-NAT转发"><a href="#5-2-配置iptables-NAT转发" class="headerlink" title="5.2  配置iptables NAT转发"></a>5.2  配置iptables NAT转发</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# systemctl  stop  firewalld.service</span><br><span class="line">[root@test ~]# systemctl  disable  firewalld.service</span><br><span class="line">[root@test ~]# yum install -y iptables-services</span><br><span class="line">[root@test ~]# systemctl enable iptables</span><br><span class="line">[root@test ~]# iptables  -F   #清空iptables配置规则</span><br><span class="line">[root@test ~]# iptables  -X</span><br><span class="line">[root@test ~]# iptables  -P OUTPUT  ACCEPT </span><br><span class="line">[root@test ~]# iptables  -P  FORWARD  ACCEPT</span><br><span class="line">[root@test ~]# iptables  -A INPUT  -i  lo  -j  ACCEPT </span><br><span class="line">[root@test ~]# iptables  -A OUTPUT  -o  lo  -j  ACCEPT</span><br><span class="line">[root@test ~]#iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">[root@test ~]# iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">[root@test ~]# iptables -A INPUT -p udp --dport 2294 -j ACCEPT </span><br><span class="line">#对vpn网段进行转发</span><br><span class="line">[root@test ~]# iptables -t nat -A POSTROUTING -o eth0 -s 20.8.8.0/24 -j MASQUERADE</span><br><span class="line">#把内部主机端口的流量指定到出口ip</span><br><span class="line">[root@test ~]# iptables -t nat  -A PREROUTING -s 100.100.100.100 -p udp -m udp --dport 2294 -j DNAT --to-destination 172.xx.xx.xx:2294  </span><br><span class="line">[root@test ~]#service  iptables  save</span><br><span class="line">[root@test ~]#service  iptables  restart</span><br></pre></td></tr></table></figure><br><h3 id="六、客户端配置文件"><a href="#六、客户端配置文件" class="headerlink" title="六、客户端配置文件"></a>六、客户端配置文件</h3><blockquote><ul><li>打开client.ovpn配置文件</li></ul></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Client</span><br><span class="line">dev tun</span><br><span class="line">proto udp</span><br><span class="line">remote 100.100.100.100  2294</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">cert  book.crt  #这里是指定用户证书，名字要和拷贝过来的文件一致</span><br><span class="line">key   book.key</span><br><span class="line">ns-cert-type server</span><br><span class="line">comp-lzo</span><br><span class="line">verb 3</span><br><span class="line">tls-auth ta.key 1   #这里客户端为1</span><br><span class="line">auth-user-pass  #这里要加上，用户密码验证</span><br></pre></td></tr></table></figure><br>]]></content>
      
      
      <categories>
          
          <category> linux 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> VPN </tag>
            
            <tag> linux 运维 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
